
---
import SocialLayout from '../../../../layouts/SocialLayout.astro';
import LeftSidebar from '../../../../components/social/LeftSidebar.astro';
import PodcastForm from '../../../../components/dashboard/forms/PodcastForm';
import { createSupabaseServerClient } from '../../../../lib/supabase';

const { id } = Astro.params;

// 1. Init Supabase
const supabase = createSupabaseServerClient({ req: Astro.request, cookies: Astro.cookies });

// 2. Auth Check
const { data: { user } } = await supabase.auth.getUser();
if (!user) return Astro.redirect('/login');

// 3. Fetch Podcast Data
const { data: podcast, error } = await supabase
    .from('podcasts')
    .select(`
        *,
        podcasts_topics:topic_id (
            slug
        )
    `) // Note: 'podcasts' has direct 'topic_id', but querying relation for slug if needed. 
       // Actually 'podcasts' table has 'topic_id' column, but we need the slug for the form default.
       // Supabase relation syntax depends on explicit names. 
       // Since I migrated topic_id as FK, I can likely just fetch topics(slug) joined on topic_id.
       // Or simpler: fetch topic separately or just use topic_id if form handles it. 
       // PodcastForm uses 'topic_slug' in initialData.
    .eq('id', id)
    .single();

if (error || !podcast) {
    return Astro.redirect('/404');
}

// 4. Ownership & Permission Check
const { data: userProfile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
const userRole = userProfile?.role || 'Basic';
const isModerator = ['Administrator', 'CountryManager'].includes(userRole);

if (podcast.author_id !== user.id && !isModerator) {
    return Astro.redirect('/403');
}

// 5. Prepare Initial Data
// Resolve Topic Slug
let topicSlug = '';
if (podcast.topic_id) {
    const { data: t } = await supabase.from('topics').select('slug').eq('id', podcast.topic_id).single();
    if (t) topicSlug = t.slug;
}

const initialData = {
    ...podcast,
    topic_slug: topicSlug // Inject slug for form
};

---

<SocialLayout title={`Edit ${podcast.title}`} hideRightSidebar={true}>
    <LeftSidebar slot="left-sidebar" />
    
    <div class="max-w-5xl mx-auto px-4 py-8">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-[#202124] mb-2">Edit Podcast</h1>
            <p class="text-gray-600">Update your show details and episodes.</p>
        </div>

        <PodcastForm client:load currentUser={user} initialData={initialData} />
    </div>
</SocialLayout>
