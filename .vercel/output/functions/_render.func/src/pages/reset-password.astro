---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Set New Password - ZVENIA">
  <div class="min-h-screen bg-[var(--bg-body)] flex flex-col justify-center px-6">
    <div class="max-w-md mx-auto w-full">
      <div class="bg-[var(--bg-card)] p-8 rounded-xl border border-[var(--border-color)] shadow-2xl">
        <h1 class="text-2xl font-bold text-[var(--text-main)] mb-2">Set New Password</h1>
        <p class="text-sm text-[var(--text-secondary)] mb-6">
          Enter your new password below.
        </p>

        <form id="reset-form" class="space-y-4">
          <div>
            <label for="password" class="block text-sm font-medium text-[var(--text-main)] mb-2">
              New Password
            </label>
            <input
              id="password"
              name="password"
              type="password"
              autocomplete="new-password"
              required
              minlength="6"
              class="block w-full rounded-lg border-0 bg-[var(--bg-surface-hover)] py-3.5 px-4 text-[var(--text-main)] ring-1 ring-inset ring-[var(--border-color)] placeholder:text-[var(--text-secondary)] focus:ring-2 focus:ring-primary-500 text-lg transition-all"
              placeholder="Enter new password"
            />
          </div>

          <div>
            <label for="confirm-password" class="block text-sm font-medium text-[var(--text-main)] mb-2">
              Confirm Password
            </label>
            <input
              id="confirm-password"
              name="confirm-password"
              type="password"
              autocomplete="new-password"
              required
              minlength="6"
              class="block w-full rounded-lg border-0 bg-[var(--bg-surface-hover)] py-3.5 px-4 text-[var(--text-main)] ring-1 ring-inset ring-[var(--border-color)] placeholder:text-[var(--text-secondary)] focus:ring-2 focus:ring-primary-500 text-lg transition-all"
              placeholder="Confirm new password"
            />
          </div>

          <button
            type="submit"
            class="w-full justify-center rounded-lg bg-[#00c44b] px-4 py-3.5 text-lg font-bold text-white hover:bg-[#00a03d] focus:outline-none focus:ring-2 focus:ring-[#00c44b] focus:ring-offset-2 transition-all shadow-lg transform active:scale-[0.98]"
          >
            Update Password
          </button>

          <div id="message" class="hidden mt-4 p-4 rounded-lg text-sm"></div>

          <div class="text-center pt-4">
            <a href="/login" class="text-sm font-medium text-primary-500 hover:text-primary-400 hover:underline">
              Back to Login
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('reset-form') as HTMLFormElement;
  const messageDiv = document.getElementById('message') as HTMLDivElement;
  
  // Variable para rastrear si la sesión está establecida
  let sessionEstablished = false;

  // Manejar token del hash (#access_token=...)
  async function handleHashToken() {
    const hash = window.location.hash;
    if (hash && hash.includes('access_token')) {
      // Parsear el hash
      const params = new URLSearchParams(hash.substring(1));
      const accessToken = params.get('access_token');
      const refreshToken = params.get('refresh_token');
      const type = params.get('type');

      if (type === 'recovery' && accessToken) {
        // Establecer la sesión con el token de recovery
        try {
          const { error } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken || '',
          });

          if (error) {
            messageDiv.textContent = 'Invalid or expired reset link. Please request a new one.';
            messageDiv.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
            messageDiv.classList.remove('hidden');
            // Limpiar el hash
            window.history.replaceState(null, '', '/reset-password');
            return;
          }

          // Limpiar el hash de la URL
          window.history.replaceState(null, '', '/reset-password');
          sessionEstablished = true; // Marcar como establecida
          return true;
        } catch (error: any) {
          messageDiv.textContent = 'Error processing reset link. Please try again.';
          messageDiv.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
          messageDiv.classList.remove('hidden');
          window.history.replaceState(null, '', '/reset-password');
          return false;
        }
      }
    }
    return false;
  }

  // Ejecutar al cargar la página
  handleHashToken().then(established => {
    if (established) {
      sessionEstablished = true;
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const password = (form.querySelector('#password') as HTMLInputElement).value;
    const confirmPassword = (form.querySelector('#confirm-password') as HTMLInputElement).value;

    if (password !== confirmPassword) {
      messageDiv.textContent = 'Passwords do not match.';
      messageDiv.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
      messageDiv.classList.remove('hidden');
      return;
    }

    if (password.length < 6) {
      messageDiv.textContent = 'Password must be at least 6 characters.';
      messageDiv.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
      messageDiv.classList.remove('hidden');
      return;
    }

    messageDiv.classList.add('hidden');
    messageDiv.classList.remove('bg-green-50', 'text-green-800', 'border-green-200', 'bg-red-50', 'text-red-800', 'border-red-200');

    try {
      // Verificar que la sesión esté establecida, si no, intentar establecerla
      if (!sessionEstablished) {
        const established = await handleHashToken();
        if (!established) {
          messageDiv.textContent = 'Please use the reset link from your email. The link may have expired.';
          messageDiv.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
          messageDiv.classList.remove('hidden');
          return;
        }
      }

      // Verificar que la sesión esté establecida antes de continuar
      if (!sessionEstablished) {
        const established = await handleHashToken();
        if (!established) {
          throw new Error('Please use the reset link from your email. The link may have expired.');
        }
        sessionEstablished = true;
      }

      // Verificar que el usuario esté autenticado
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        throw new Error('You must be logged in to reset your password. Please use the link from your email.');
      }

      const { error } = await supabase.auth.updateUser({
        password: password,
      });

      if (error) {
        throw error;
      }

      messageDiv.textContent = 'Password updated successfully! Redirecting to your profile...';
      messageDiv.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200');
      messageDiv.classList.remove('hidden');

      // El usuario ya está autenticado después de resetear, redirigir a su área de usuario
      setTimeout(() => {
        window.location.href = '/dashboard/profile';
      }, 2000);
    } catch (error: any) {
      messageDiv.textContent = error.message || 'Failed to update password. The reset link may have expired.';
      messageDiv.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
      messageDiv.classList.remove('hidden');
    }
  });
</script>

