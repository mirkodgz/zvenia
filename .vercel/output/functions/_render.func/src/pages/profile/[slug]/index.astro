---
import SocialLayout from "../../../layouts/SocialLayout.astro";
import { createSupabaseServerClient } from "../../../lib/supabase";
import LeftSidebar from "../../../components/social/LeftSidebar.astro";
import RightSidebar from "../../../components/social/RightSidebar.astro";
import { normalizeProfileSlug } from "../../../lib/utils";
import PostCard from "../../../components/social/PostCard.astro";
import PodcastCard from "../../../components/social/PodcastCard";
import EventCard from "../../../components/social/EventCard";
import ServiceCard from "../../../components/social/ServiceCard";

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/");
}

// Normalize slug
const normalizedSlug = normalizeProfileSlug(slug);

// Get profile
const supabase = createSupabaseServerClient({
    req: Astro.request,
    cookies: Astro.cookies,
});
const { data: profileData, error } = await supabase
    .from("profiles")
    .select("*")
    .eq("profile_slug", normalizedSlug)
    .single();

const profile: any = profileData;

if (error || !profile) {
    return Astro.redirect("/");
}

// Fetch User Content
const { data: posts } = await supabase
    .from("posts")
    .select("*, author:profiles(*), topic:topics(*)") // Get author and topic details
    .eq("author_id", profile.id)
    .order("created_at", { ascending: false });

const { data: podcasts } = await supabase
    .from("podcasts")
    .select("*")
    .eq("author_id", profile.id)
    .order("created_at", { ascending: false });

const { data: events } = await supabase
    .from("events")
    .select("*")
    .eq("organizer_id", profile.id)
    .order("start_date", { ascending: false });

const { data: services } = await supabase
    .from("services")
    .select("*")
    .eq("provider_id", profile.id)
    .order("created_at", { ascending: false });

// Parse metadata
const metadata = (profile.metadata as any) || {};
const othersLanguages = Array.isArray(metadata.others_languages)
    ? metadata.others_languages
    : [];
const othersAreas = Array.isArray(metadata.others_areas_of_expertise)
    ? metadata.others_areas_of_expertise
    : [];

// Privacy
const privacy = metadata.privacy || {};
const isFieldVisible = (
    field: string,
    defaultValue: boolean = true,
): boolean => {
    if (privacy[field] === undefined) return defaultValue;
    return privacy[field] === true;
};

// Resolve IDs
let nationalityName = profile.nationality || null;
let workCountryName = profile.work_country || null;
let mainLanguageName = profile.main_language || null;
let mainAreaName = profile.main_area_of_expertise || null;
let othersAreasNames: string[] = [];
let othersLanguagesNames: string[] = [];

if (profile.nationality && !isNaN(Number(profile.nationality))) {
    const { data } = await supabase
        .from("countries")
        .select("display_name")
        .eq("id", parseInt(profile.nationality))
        .single();
    const countryData = data as any;
    if (countryData) nationalityName = countryData.display_name;
}
if (profile.work_country && !isNaN(Number(profile.work_country))) {
    const { data } = await supabase
        .from("countries")
        .select("display_name")
        .eq("id", parseInt(profile.work_country))
        .single();
    const workCountryData = data as any;
    if (workCountryData) workCountryName = workCountryData.display_name;
}
if (profile.main_language && !isNaN(Number(profile.main_language))) {
    const { data } = await supabase
        .from("languages")
        .select("display_name")
        .eq("id", parseInt(profile.main_language))
        .single();
    const langData = data as any;
    if (langData) mainLanguageName = langData.display_name;
}
if (
    profile.main_area_of_expertise &&
    !isNaN(Number(profile.main_area_of_expertise))
) {
    const { data: topic } = await supabase
        .from("topics")
        .select("name")
        .eq("id", parseInt(profile.main_area_of_expertise))
        .single();
    const topicData = topic as any;
    if (topicData) mainAreaName = topicData.name;
    else {
        const { data: miningTopic } = await supabase
            .from("mining_topics")
            .select("display_name")
            .eq("id", parseInt(profile.main_area_of_expertise))
            .single();
        const miningTopicData = miningTopic as any;
        if (miningTopicData) mainAreaName = miningTopicData.display_name;
    }
}

// Resolver others_areas_of_expertise (array de IDs)
if (othersAreas.length > 0) {
    const areaIds = othersAreas
        .map((a: any) => {
            const num = parseInt(String(a));
            return isNaN(num) ? null : num;
        })
        .filter((id: any) => id !== null) as number[];

    if (areaIds.length > 0) {
        // Intentar primero en topics
        const { data: topics } = await supabase
            .from("topics")
            .select("name")
            .in("id", areaIds);

        if (topics && topics.length > 0) {
            othersAreasNames = (topics as any[]).map((t) => t.name);
        } else {
            // Si no est√°n en topics, intentar en mining_topics
            const { data: miningTopics } = await supabase
                .from("mining_topics")
                .select("display_name")
                .in("id", areaIds);

            if (miningTopics) {
                othersAreasNames = (miningTopics as any[]).map(
                    (t) => t.display_name,
                );
            }
        }
    }
}

// Resolver others_languages (array de IDs)
// Resolver others_languages (array de IDs)
if (othersLanguages.length > 0) {
    const langIds = othersLanguages
        .map((l: any) => {
            const num = parseInt(String(l));
            return isNaN(num) ? null : num;
        })
        .filter((id: any) => id !== null) as number[];

    if (langIds.length > 0) {
        const { data: languages } = await supabase
            .from("languages")
            .select("display_name")
            .in("id", langIds);

        if (languages) {
            othersLanguagesNames = (languages as any[]).map(
                (l) => l.display_name,
            );
        }
    }
}

// Informaci√≥n del usuario actual (si est√° logueado)
const currentUser = Astro.locals.user;
const isOwnProfile = currentUser?.id === profile.id;
---

<SocialLayout title={`${profile.full_name || profile.email} - Public Profile`}>
    <LeftSidebar slot="left-sidebar" />

    <div class="max-w-4xl mx-auto space-y-6">
        <div
            class="bg-white rounded-sm border border-gray-200 overflow-hidden shadow-[1px_2px_2px_2px_#22232633]"
        >
            <!-- Banner -->
            <div
                class="h-48 relative"
                style="background-image: url('https://res.cloudinary.com/dun3slcfg/images/v1691587336/cloud-files/Background-Default-/Background-Default-.jpg'); background-position: right center; background-size: 200% auto; background-repeat: no-repeat;"
            >
                <div class="absolute top-4 right-4">
                    <img
                        src="/zvenia-Logo.svg"
                        alt="ZVENIA"
                        class="h-16 opacity-30"
                    />
                </div>
            </div>

            <div class="px-6 pb-6 relative">
                <!-- Avatar -->
                <div class="absolute -top-20 left-6">
                    <div
                        class="w-32 h-32 rounded-full border-4 border-white bg-gray-200 flex items-center justify-center overflow-hidden shadow-lg"
                    >
                        {
                            profile.avatar_url ? (
                                <img
                                    src={profile.avatar_url}
                                    alt={profile.full_name || "User"}
                                    class="w-full h-full object-cover"
                                />
                            ) : (
                                <span class="text-4xl font-bold text-gray-400">
                                    {(profile.full_name ||
                                        profile.email ||
                                        "U")[0].toUpperCase()}
                                </span>
                            )
                        }
                    </div>
                </div>

                <!-- Header Actions -->
                <div class="flex justify-end pt-4 min-h-[60px]">
                    {
                        isOwnProfile && (
                            <a
                                href="/dashboard/profile/edit"
                                class="inline-flex items-center gap-2 px-4 py-2 bg-accent-500 text-white rounded-lg hover:bg-[#00a33f] transition-colors font-medium text-sm"
                            >
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                                    />
                                </svg>
                                Edit Profile
                            </a>
                        )
                    }
                </div>

                <!-- Basic Info -->
                <div class="mt-2 mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <h1 class="text-2xl font-bold text-dark">
                            {profile.full_name || profile.email}
                        </h1>
                        {
                            (profile.role === "Expert" ||
                                profile.role === "CountryManager" ||
                                profile.role === "Administrator") && (
                                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium flex items-center gap-1">
                                    <svg
                                        class="w-3 h-3"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd"
                                        />
                                    </svg>
                                    Verified user
                                </span>
                            )
                        }
                    </div>

                    {
                        profile.headline_user && (
                            <p class="text-dark mb-2 text-[15px] font-normal leading-relaxed">
                                {profile.headline_user}
                            </p>
                        )
                    }

                    <div
                        class="text-sm text-gray-500 flex flex-wrap gap-x-4 gap-y-1"
                    >
                        {workCountryName && <span>{workCountryName}</span>}
                        {
                            workCountryName &&
                                (profile.company || profile.position) && (
                                    <span>‚Ä¢</span>
                                )
                        }
                        {profile.position && <span>{profile.position}</span>}
                        {profile.position && profile.company && <span>at</span>}
                        {profile.company && <span>{profile.company}</span>}
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div class="border-b border-gray-200 mb-6">
                    <nav
                        class="-mb-px flex space-x-8"
                        aria-label="Tabs"
                        id="profile-tabs"
                    >
                        <button
                            data-tab="overview"
                            class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-accent-500 text-accent-500"
                        >
                            Overview
                        </button>
                        <button
                            data-tab="posts"
                            class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                        >
                            Posts <span
                                class="ml-1 px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs"
                                >{posts?.length || 0}</span
                            >
                        </button>
                        <button
                            data-tab="podcasts"
                            class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                        >
                            Podcasts <span
                                class="ml-1 px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs"
                                >{podcasts?.length || 0}</span
                            >
                        </button>
                        <button
                            data-tab="events"
                            class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                        >
                            Events <span
                                class="ml-1 px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs"
                                >{events?.length || 0}</span
                            >
                        </button>
                        <button
                            data-tab="services"
                            class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                        >
                            Services <span
                                class="ml-1 px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs"
                                >{services?.length || 0}</span
                            >
                        </button>
                    </nav>
                </div>

                <!-- Tab Contents -->
                <div id="tab-contents">
                    <!-- Overview Tab -->
                    <div
                        id="overview"
                        class="tab-content animate-in fade-in duration-300"
                    >
                        <!-- Contact Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <span
                                    class="text-xs uppercase block mb-1 font-bold text-primary-500"
                                    >E-mail</span
                                >
                                <p class="text-dark text-[15px]">
                                    {profile.email}
                                </p>
                            </div>
                            {
                                profile.phone_number &&
                                    isFieldVisible("phone_number", false) && (
                                        <div>
                                            <span class="text-xs uppercase block mb-1 font-bold text-primary-500">
                                                Phone number
                                            </span>
                                            <p class="text-dark text-[15px]">
                                                {profile.phone_number}
                                            </p>
                                        </div>
                                    )
                            }
                            {
                                nationalityName &&
                                    isFieldVisible("nationality", true) && (
                                        <div>
                                            <span class="text-xs uppercase block mb-1 font-bold text-primary-500">
                                                Nationality
                                            </span>
                                            <p class="text-dark text-[15px]">
                                                {nationalityName}
                                            </p>
                                        </div>
                                    )
                            }
                        </div>

                        <div class="border-t border-gray-200 my-6"></div>

                        <!-- Professional Info -->
                        <h3 class="text-lg font-bold text-dark mb-4">
                            Professional info
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {
                                workCountryName &&
                                    isFieldVisible("work_country", true) && (
                                        <div>
                                            <span class="text-xs uppercase block mb-1 font-bold text-primary-500">
                                                Work country
                                            </span>
                                            <p class="text-dark text-[15px]">
                                                {workCountryName}
                                            </p>
                                        </div>
                                    )
                            }
                            {
                                profile.profession &&
                                    isFieldVisible("profession", true) && (
                                        <div>
                                            <span class="text-xs uppercase block mb-1 font-bold text-primary-500">
                                                Profession
                                            </span>
                                            <p class="text-dark text-[15px]">
                                                {profile.profession}
                                            </p>
                                        </div>
                                    )
                            }
                            {
                                profile.company &&
                                    isFieldVisible("company", true) && (
                                        <div>
                                            <span class="text-xs uppercase block mb-1 font-bold text-primary-500">
                                                Current company
                                            </span>
                                            <p class="text-dark text-[15px]">
                                                {profile.company}
                                            </p>
                                        </div>
                                    )
                            }
                            {
                                profile.position &&
                                    isFieldVisible("position", true) && (
                                        <div>
                                            <span class="text-xs uppercase block mb-1 font-bold text-primary-500">
                                                Current position
                                            </span>
                                            <p class="text-dark text-[15px]">
                                                {profile.position}
                                            </p>
                                        </div>
                                    )
                            }
                            {
                                profile.linkedin_url &&
                                    isFieldVisible("linkedin_url", true) && (
                                        <div>
                                            <span class="text-xs uppercase block mb-1 font-bold text-primary-500">
                                                Linkedin URL
                                            </span>
                                            <a
                                                href={
                                                    profile.linkedin_url.startsWith(
                                                        "http",
                                                    )
                                                        ? profile.linkedin_url
                                                        : `https://${profile.linkedin_url}`
                                                }
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                class="text-accent-500 hover:underline break-all text-[15px]"
                                            >
                                                {profile.linkedin_url}
                                            </a>
                                        </div>
                                    )
                            }
                            {
                                mainLanguageName &&
                                    isFieldVisible("main_language", true) && (
                                        <div>
                                            <span class="text-xs uppercase block mb-1 font-bold text-primary-500">
                                                Main language
                                            </span>
                                            <p class="text-dark text-[15px]">
                                                {mainLanguageName}
                                            </p>
                                        </div>
                                    )
                            }
                            {
                                mainAreaName &&
                                    isFieldVisible(
                                        "main_area_of_expertise",
                                        true,
                                    ) && (
                                        <div>
                                            <span class="text-xs uppercase block mb-1 font-bold text-primary-500">
                                                Main area of expertise
                                            </span>
                                            <p class="text-dark text-[15px]">
                                                {mainAreaName}
                                            </p>
                                        </div>
                                    )
                            }
                        </div>
                    </div>

                    <!-- Posts Tab -->
                    <div
                        id="posts"
                        class="tab-content hidden animate-in fade-in duration-300"
                    >
                        {
                            posts && posts.length > 0 ? (
                                <div class="space-y-6">
                                    {posts.map((post) => (
                                        <PostCard
                                            post={post}
                                            currentUser={currentUser}
                                        />
                                    ))}
                                </div>
                            ) : (
                                <div class="py-12 text-center text-gray-500">
                                    <span class="text-4xl block mb-2">üìù</span>
                                    <p>No posts published yet.</p>
                                </div>
                            )
                        }
                    </div>

                    <!-- Podcasts Tab -->
                    <div
                        id="podcasts"
                        class="tab-content hidden animate-in fade-in duration-300"
                    >
                        {
                            podcasts && podcasts.length > 0 ? (
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {podcasts.map((podcast) => (
                                        <PodcastCard
                                            client:visible
                                            podcast={podcast}
                                            currentUser={currentUser}
                                        />
                                    ))}
                                </div>
                            ) : (
                                <div class="py-12 text-center text-gray-500">
                                    <span class="text-4xl block mb-2">üéôÔ∏è</span>
                                    <p>No podcasts available.</p>
                                </div>
                            )
                        }
                    </div>

                    <!-- Events Tab -->
                    <div
                        id="events"
                        class="tab-content hidden animate-in fade-in duration-300"
                    >
                        {
                            events && events.length > 0 ? (
                                <div class="space-y-4">
                                    {events.map((event) => (
                                        <EventCard
                                            client:visible
                                            event={event}
                                            currentUser={currentUser}
                                        />
                                    ))}
                                </div>
                            ) : (
                                <div class="py-12 text-center text-gray-500">
                                    <span class="text-4xl block mb-2">üìÖ</span>
                                    <p>No upcoming events.</p>
                                </div>
                            )
                        }
                    </div>

                    <!-- Services Tab -->
                    <div
                        id="services"
                        class="tab-content hidden animate-in fade-in duration-300"
                    >
                        {
                            services && services.length > 0 ? (
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {services.map((service) => (
                                        <ServiceCard
                                            client:visible
                                            service={service}
                                            currentUser={currentUser}
                                        />
                                    ))}
                                </div>
                            ) : (
                                <div class="py-12 text-center text-gray-500">
                                    <span class="text-4xl block mb-2">üíº</span>
                                    <p>No services listed.</p>
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <RightSidebar slot="right-sidebar" />
</SocialLayout>

<script>
    document.addEventListener("astro:page-load", setupTabs);
    document.addEventListener("DOMContentLoaded", setupTabs);

    function setupTabs() {
        const buttons = document.querySelectorAll(".tab-btn");
        const contents = document.querySelectorAll(".tab-content");

        buttons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const targetId = btn.getAttribute("data-tab");

                // Update buttons
                buttons.forEach((b) => {
                    b.classList.remove("border-accent-500", "text-accent-500");
                    b.classList.add("border-transparent", "text-gray-500");
                });
                btn.classList.add("border-accent-500", "text-accent-500");
                btn.classList.remove("border-transparent", "text-gray-500");

                // Update contents
                contents.forEach((content) => {
                    content.classList.add("hidden");
                    if (content.id === targetId) {
                        content.classList.remove("hidden");
                    }
                });
            });
        });
    }
</script>
