---
import SocialLayout from '../../../layouts/SocialLayout.astro';
import { createSupabaseServerClient } from '../../../lib/supabase';
import LeftSidebar from '../../../components/social/LeftSidebar.astro';
import RightSidebar from '../../../components/social/RightSidebar.astro';
import { normalizeProfileSlug } from '../../../lib/utils';

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect('/');
}

// Normalizar slug
const normalizedSlug = normalizeProfileSlug(slug);

// Obtener perfil por slug
const supabase = createSupabaseServerClient({ req: Astro.request, cookies: Astro.cookies });
const { data: profile, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('profile_slug', normalizedSlug)
    .single();

if (error || !profile) {
    return Astro.redirect('/');
}

// Parsear metadata si existe (puede no existir en algunos schemas)
const metadata = (profile.metadata as any) || {};
const othersLanguages = Array.isArray(metadata.others_languages) ? metadata.others_languages : [];
const othersAreas = Array.isArray(metadata.others_areas_of_expertise) ? metadata.others_areas_of_expertise : [];

// Privacy settings - valores por defecto si no existen
const privacy = metadata.privacy || {};
const isFieldVisible = (field: string, defaultValue: boolean = true): boolean => {
    // Si el campo no está en privacy, usar el valor por defecto
    if (privacy[field] === undefined) return defaultValue;
    return privacy[field] === true;
};

// Resolver IDs a nombres reales desde tablas de referencia
let nationalityName = profile.nationality || null;
let workCountryName = profile.work_country || null;
let mainLanguageName = profile.main_language || null;
let mainAreaName = profile.main_area_of_expertise || null;
let othersAreasNames: string[] = [];

// Si nationality es un número, buscar en countries
if (profile.nationality && !isNaN(Number(profile.nationality))) {
    const { data: country } = await supabase
        .from('countries')
        .select('display_name')
        .eq('id', parseInt(profile.nationality))
        .single();
    nationalityName = country?.display_name || profile.nationality;
}

// Si work_country es un número, buscar en countries
if (profile.work_country && !isNaN(Number(profile.work_country))) {
    const { data: country } = await supabase
        .from('countries')
        .select('display_name')
        .eq('id', parseInt(profile.work_country))
        .single();
    workCountryName = country?.display_name || profile.work_country;
}

// Si main_language es un número, buscar en languages
if (profile.main_language && !isNaN(Number(profile.main_language))) {
    const { data: language } = await supabase
        .from('languages')
        .select('display_name')
        .eq('id', parseInt(profile.main_language))
        .single();
    mainLanguageName = language?.display_name || profile.main_language;
}

// Si main_area_of_expertise es un número, buscar en topics o mining_topics
if (profile.main_area_of_expertise && !isNaN(Number(profile.main_area_of_expertise))) {
    // Intentar primero en topics
    const { data: topic } = await supabase
        .from('topics')
        .select('name')
        .eq('id', parseInt(profile.main_area_of_expertise))
        .single();
    
    if (topic) {
        mainAreaName = topic.name;
    } else {
        // Si no está en topics, intentar en mining_topics
        const { data: miningTopic } = await supabase
            .from('mining_topics')
            .select('display_name')
            .eq('id', parseInt(profile.main_area_of_expertise))
            .single();
        mainAreaName = miningTopic?.display_name || profile.main_area_of_expertise;
    }
}

// Resolver others_areas_of_expertise (array de IDs)
if (othersAreas.length > 0) {
    const areaIds = othersAreas
        .map(a => {
            const num = parseInt(String(a));
            return isNaN(num) ? null : num;
        })
        .filter(id => id !== null) as number[];
    
    if (areaIds.length > 0) {
        // Intentar primero en topics
        const { data: topics } = await supabase
            .from('topics')
            .select('name')
            .in('id', areaIds);
        
        if (topics && topics.length > 0) {
            othersAreasNames = topics.map(t => t.name);
        } else {
            // Si no están en topics, intentar en mining_topics
            const { data: miningTopics } = await supabase
                .from('mining_topics')
                .select('display_name')
                .in('id', areaIds);
            
            if (miningTopics) {
                othersAreasNames = miningTopics.map(t => t.display_name);
            }
        }
    }
}

// Resolver others_languages (array de IDs)
let othersLanguagesNames: string[] = [];
if (othersLanguages.length > 0) {
    const langIds = othersLanguages
        .map(l => {
            const num = parseInt(String(l));
            return isNaN(num) ? null : num;
        })
        .filter(id => id !== null) as number[];
    
    if (langIds.length > 0) {
        const { data: languages } = await supabase
            .from('languages')
            .select('display_name')
            .in('id', langIds);
        
        if (languages) {
            othersLanguagesNames = languages.map(l => l.display_name);
        }
    }
}

// Información del usuario actual (si está logueado)
const currentUser = Astro.locals.user;
const isOwnProfile = currentUser?.id === profile.id;
---

<SocialLayout title={`${profile.full_name || profile.email} - Public Profile`}>
    <LeftSidebar slot="left-sidebar" />

    <div class="max-w-4xl mx-auto space-y-6">
        <!-- Card 1: Personal Details -->
        <div class="bg-white rounded-sm border border-gray-200 overflow-hidden" style="box-shadow: 1px 2px 2px 2px #22232633;">
            <!-- Banner con imagen de fondo -->
            <div 
                class="h-48 relative"
                style="background-image: url('https://res.cloudinary.com/dun3slcfg/images/v1691587336/cloud-files/Background-Default-/Background-Default-.jpg'); background-position: right center; background-size: 200% auto; background-repeat: no-repeat;"
            >
                <div class="absolute top-4 right-4">
                    <img src="/zvenia-Logo.svg" alt="ZVENIA" class="h-16 opacity-30" />
                </div>
            </div>

            <!-- Profile Header -->
            <div class="px-6 pb-6 relative">
                <!-- Avatar superpuesto al banner -->
                <div class="absolute -top-20 left-6">
                    <div class="w-32 h-32 rounded-full border-4 border-white bg-gray-200 flex items-center justify-center overflow-hidden shadow-lg">
                        {profile.avatar_url ? (
                            <img src={profile.avatar_url} alt={profile.full_name || 'User'} class="w-full h-full object-cover" />
                        ) : (
                            <span class="text-4xl font-bold text-gray-400">
                                {(profile.full_name || profile.email || 'U')[0].toUpperCase()}
                            </span>
                        )}
                    </div>
                </div>

                <!-- Name and Badge -->
                <div class="pt-20">
                    <div class="flex items-center gap-3 mb-3">
                        <h1 class="text-2xl font-bold text-[#202124]">
                            {profile.full_name || profile.email}
                        </h1>
                        {(profile.role === 'Expert' || profile.role === 'CountryManager' || profile.role === 'Administrator') && (
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                Verified user
                            </span>
                        )}
                    </div>

                    <!-- Bio/Summary -->
                    {profile.headline_user && (
                        <p class="text-[#202124] mb-4" style="font-size: 15px; font-weight: 400; line-height: 1.5;">
                            {profile.headline_user}
                        </p>
                    )}

                    <!-- Contact Information -->
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">E-mail</span>
                                <p class="text-[#202124]" style="font-size: 15px;">{profile.email}</p>
                            </div>
                            {profile.phone_number && isFieldVisible('phone_number', false) && (
                                <div>
                                    <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">Phone number</span>
                                    <p class="text-[#202124]" style="font-size: 15px;">{profile.phone_number}</p>
                                </div>
                            )}
                        </div>
                        {nationalityName && isFieldVisible('nationality', true) && (
                            <div class="mt-4">
                                <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">Nationality</span>
                                <p class="text-[#202124]" style="font-size: 15px;">{nationalityName}</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 2: Professional Info -->
        <div class="bg-white rounded-sm border border-gray-200 overflow-hidden" style="box-shadow: 1px 2px 2px 2px #22232633;">
            <div class="p-6">
                <h2 class="text-lg font-bold text-[#202124] mb-6">Professional info</h2>
                <div class="space-y-4">
                    {workCountryName && isFieldVisible('work_country', true) && (
                        <div>
                            <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">Work country</span>
                            <p class="text-[#202124]" style="font-size: 15px;">{workCountryName}</p>
                        </div>
                    )}
                    {profile.profession && isFieldVisible('profession', true) && (
                        <div>
                            <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">Profession</span>
                            <p class="text-[#202124]" style="font-size: 15px;">{profile.profession}</p>
                        </div>
                    )}
                    {profile.company && isFieldVisible('company', true) && (
                        <div>
                            <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">Current company</span>
                            <p class="text-[#202124]" style="font-size: 15px;">{profile.company}</p>
                        </div>
                    )}
                    {profile.position && isFieldVisible('position', true) && (
                        <div>
                            <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">Current position</span>
                            <p class="text-[#202124]" style="font-size: 15px;">{profile.position}</p>
                        </div>
                    )}
                    {profile.linkedin_url && isFieldVisible('linkedin_url', true) && (
                        <div>
                            <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">Linkedin URL</span>
                            <a href={profile.linkedin_url.startsWith('http') ? profile.linkedin_url : `https://${profile.linkedin_url}`} 
                               target="_blank" 
                               rel="noopener noreferrer"
                               class="text-[#00c44b] hover:underline break-all" style="font-size: 15px;">
                                {profile.linkedin_url}
                            </a>
                        </div>
                    )}
                    {mainLanguageName && isFieldVisible('main_language', true) && (
                        <div>
                            <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">Main language</span>
                            <p class="text-[#202124]" style="font-size: 15px;">{mainLanguageName}</p>
                        </div>
                    )}
                    {mainAreaName && isFieldVisible('main_area_of_expertise', true) && (
                        <div>
                            <span class="text-xs uppercase block mb-1 font-bold" style="color: #0d241b;">Main area of expertise</span>
                            <p class="text-[#202124]" style="font-size: 15px;">{mainAreaName}</p>
                        </div>
                    )}
                </div>
            </div>
        </div>

        <!-- Edit Profile Link (solo si es el propio perfil) -->
        {isOwnProfile && (
            <div class="bg-white rounded-sm border border-gray-200 p-6" style="box-shadow: 1px 2px 2px 2px #22232633;">
                <a href="/dashboard/profile/edit" 
                   class="inline-flex items-center gap-2 px-4 py-2 bg-[#00c44b] text-white rounded-lg hover:bg-[#00a33f] transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Edit Profile
                </a>
            </div>
        )}
    </div>

    <RightSidebar slot="right-sidebar" />
</SocialLayout>

