---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import PostFormAdmin from '../../../components/admin/forms/PostFormAdmin';
import { createSupabaseServerClient } from '../../../lib/supabase';
import { isAdministrator, type UserRole } from '../../../lib/admin/roles';

// Server Side Protection
const user = Astro.locals.user;
const profile = (Astro.locals as any).profile;
const userRole = (profile?.role || (user as any)?.role || 'Basic') as UserRole;

if (!user || !isAdministrator(userRole)) {
    return Astro.redirect('/');
}

// Fetch topics for the form
const supabase = createSupabaseServerClient({ req: Astro.request, cookies: Astro.cookies });
const { data: topics } = await supabase
    .from('topics')
    .select('id, name, slug')
    .order('name');
---

<AdminLayout title="Create Post" activePage="posts">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-white tracking-tight">Create New Post</h1>
        <p class="text-gray-400 text-sm mt-1">Add a new post to the platform.</p>
    </div>

    <!-- Post Form Component -->
    <PostFormAdmin client:load currentUser={user} topics={topics || []} />
</AdminLayout>

