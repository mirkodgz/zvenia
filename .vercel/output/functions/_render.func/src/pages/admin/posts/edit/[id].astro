---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import PostFormAdmin from '../../../../components/admin/forms/PostFormAdmin';
import { createSupabaseServerClient } from '../../../../lib/supabase';
import { isAdministrator, type UserRole } from '../../../../lib/admin/roles';

// Server Side Protection
const user = Astro.locals.user;
const profile = (Astro.locals as any).profile;
const userRole = (profile?.role || (user as any)?.role || 'Basic') as UserRole;

if (!user || !isAdministrator(userRole)) {
    return Astro.redirect('/');
}

const { id } = Astro.params;
if (!id) {
    return Astro.redirect('/admin/posts');
}

// Fetch post data
const supabase = createSupabaseServerClient({ req: Astro.request, cookies: Astro.cookies });
const { data: post, error } = await supabase
    .from('posts')
    .select('*')
    .eq('id', id)
    .single();

if (error || !post) {
    return Astro.redirect('/admin/posts');
}

// Fetch topic slug
let topicSlug = '';
if (post.topic_id) {
    const { data: topicData } = await supabase
        .from('topics')
        .select('slug')
        .eq('id', post.topic_id)
        .single();
    if (topicData) {
        topicSlug = topicData.slug;
    }
}

// Fetch all topics for the form
const { data: topics } = await supabase
    .from('topics')
    .select('id, name, slug')
    .order('name');

// Prepare initial data
const initialData = {
    ...post,
    topic_id: topicSlug
};
---

<AdminLayout title="Edit Post" activePage="posts">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-white tracking-tight">Edit Post</h1>
        <p class="text-gray-400 text-sm mt-1">Update post information and content.</p>
    </div>

    <!-- Post Form Component -->
    <PostFormAdmin client:load currentUser={user} initialData={initialData} topics={topics || []} />
</AdminLayout>

