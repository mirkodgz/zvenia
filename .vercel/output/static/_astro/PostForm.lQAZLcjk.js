import{j as e}from"./jsx-runtime.BBGWwODT.js";import{r as u}from"./index.DYwCuWnG.js";import{s as v}from"./supabase.D-JsBXyn.js";import"./index.BWsCvz9k.js";import"./tslib.es6.eMSY344_.js";function O({currentUser:L,initialData:i}){const[a,c]=u.useState({id:i?.id||"",title:i?.title||"",slug:i?.slug||"",content:i?.content||"",featured_image_url:i?.featured_image_url||"",document_url:i?.document_url||"",source:i?.source||"",topic_id:i?.topic_id||"",metadata:i?.metadata||{gallery:[]}}),[d,b]=u.useState("image"),[S,w]=u.useState(!1),k=async o=>{const r=o.target.files;if(!(!r||r.length===0)){w(!0);try{for(let l=0;l<r.length;l++){const t=r[l],s=t.type==="application/pdf",p=t.type.startsWith("image/"),h=t.type.startsWith("video/");if(!s&&!p&&!h){alert(`Format not supported for file: ${t.name}`);continue}const g=new FormData;g.append("file",t);const y=await fetch("/api/upload",{method:"POST",body:g}),f=await y.json();if(!y.ok)throw new Error(f.error||"Upload failed");let m=f.url;h?c(n=>({...n,metadata:{...n.metadata,video_url:m}})):s?c(n=>({...n,document_url:m})):(f.format==="pdf"&&(m=m.replace(/\.pdf$/i,".jpg")),c(n=>{const I=n.metadata?.gallery||[];return n.featured_image_url?{...n,metadata:{...n.metadata,gallery:[...I,m]}}:{...n,featured_image_url:m}}))}}catch(l){console.error("Upload Error:",l),alert("Failed to upload one or more files")}finally{w(!1)}}},[T,C]=u.useState(!!i?.id),x=o=>{const{name:r,value:l}=o.target;r==="slug"&&C(!0),c(t=>{let s=t.slug;return r==="slug"?s=l:r==="title"&&!T&&(s=l.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")),{...t,[r]:l,slug:s}})},[_,j]=u.useState(!1),F=async o=>{o.preventDefault(),j(!0);try{const r=!!a.id,l=r?"/api/content/update":"/api/content/create",t={...a,metadata:a.metadata};d==="image"?(t.document_url="",t.metadata.video_url="",t.metadata.youtube_url="",!t.featured_image_url&&t.metadata.gallery?.length>0&&(t.featured_image_url=t.metadata.gallery[0],t.metadata.gallery=t.metadata.gallery.slice(1))):d==="pdf"?(t.featured_image_url="",t.metadata.gallery=[],t.metadata.video_url="",t.metadata.youtube_url=""):d==="video"?(t.featured_image_url="",t.document_url="",t.metadata.gallery=[],t.metadata.youtube_url=""):d==="youtube"&&(t.featured_image_url="",t.document_url="",t.metadata.gallery=[],t.metadata.video_url="");const s=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r?t:{type:"post",data:t})}),p=await s.json();if(!s.ok)throw new Error(p.error||"Failed to save post");alert(r?"Post updated successfully!":"Post created successfully!");const g=new URLSearchParams(window.location.search).get("returnTo")||"/";window.location.href=g}catch(r){console.error("Submission error:",r),alert(r.message)}finally{j(!1)}};u.useEffect(()=>{!i?.id&&i?.editId&&(async()=>{const r=i.editId;try{const{data:l,error:t}=await v.from("posts").select("*").eq("id",r).single();if(t||!l)throw t;const s=l;let p="";if(s.topic_id){const{data:m}=await v.from("topics").select("slug").eq("id",s.topic_id).single(),n=m;n&&(p=n.slug)}const h=s.metadata?.gallery||[],g=s.metadata?.video_url,y=s.metadata?.youtube_url,f=s.document_url;c({id:s.id,title:s.title,slug:s.slug,content:s.content,featured_image_url:s.featured_image_url||"",document_url:f||"",source:s.source||"",topic_id:p,metadata:s.metadata||{gallery:[]}}),b(y?"youtube":g?"video":f?"pdf":"image")}catch(l){console.error("Error fetching post for edit",l),alert("Failed to load post data.")}})()},[i]);const[U,P]=u.useState([]),[N,E]=u.useState(!0);return u.useEffect(()=>{(async()=>{try{const{data:r,error:l}=await v.from("topics").select("id, name, slug").order("slug",{ascending:!0});if(l)throw l;P(r||[])}catch(r){console.error("Error loading topics",r)}finally{E(!1)}})()},[]),e.jsxs("form",{onSubmit:F,className:"space-y-6 max-w-3xl mx-auto",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"topic_id",className:"block text-sm font-medium text-(--text-secondary) mb-2",children:"Topic / Category"}),e.jsxs("select",{id:"topic_id",name:"topic_id",required:!0,value:a.topic_id,onChange:x,disabled:N,className:"w-full bg-(--bg-body) border border-(--border-color) rounded-lg px-4 py-3 text-(--text-main) placeholder-gray-500 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors appearance-none",children:[e.jsx("option",{value:"",children:N?"Loading topics...":"Select a Mining Topic..."}),U.map(o=>e.jsx("option",{value:o.slug,children:o.name},o.id))]}),e.jsx("p",{className:"text-xs text-(--text-secondary) mt-1",children:"Select the most relevant mining sector for your post."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-(--text-secondary) mb-2",children:"Title"}),e.jsx("input",{type:"text",name:"title",id:"title",required:!0,value:a.title,onChange:x,className:"w-full bg-(--bg-body) border border-(--border-color) rounded-lg px-4 py-3 text-(--text-main) placeholder-gray-500 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors",placeholder:"How to optimize mining operations..."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"slug",className:"block text-sm font-medium text-(--text-secondary) mb-2",children:"Slug (URL)"}),e.jsxs("div",{className:"flex rounded-md shadow-sm",children:[e.jsx("span",{className:"inline-flex items-center px-3 rounded-l-md border border-r-0 border-(--border-color) bg-(--bg-surface-hover) text-(--text-secondary) sm:text-sm",children:"zvenia.com/post/"}),e.jsx("input",{type:"text",name:"slug",id:"slug",required:!0,value:a.slug,onChange:x,className:"flex-1 min-w-0 block w-full px-4 py-3 rounded-none rounded-r-md bg-(--bg-body) border border-(--border-color) text-(--text-main) focus:border-primary-500 focus:ring-1 focus:ring-primary-500 sm:text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-(--text-main) mb-3",children:"What would you like to share? ( Optional )"}),e.jsx("div",{className:"flex flex-wrap gap-4 mb-4",children:["image","video","pdf","youtube"].map(o=>e.jsxs("button",{type:"button",onClick:()=>{c(r=>({...r,featured_image_url:"",document_url:"",metadata:{...r.metadata,gallery:[],video_url:"",youtube_url:""}})),b(o)},className:`flex items-center gap-2 px-4 py-2 rounded-lg border transition-all capitalize ${d===o?"bg-primary-500/20 border-primary-500 text-(--text-main)":"bg-(--bg-body) border-(--border-color) text-(--text-secondary) hover:bg-(--bg-surface-hover)"}`,children:[e.jsx("span",{className:`w-4 h-4 rounded-sm border ${d===o?"bg-primary-500 border-primary-500":"border-gray-500"}`}),o==="youtube"?"YouTube Video":o]},o))}),e.jsx("div",{className:"border-2 border-dashed border-(--border-color) rounded-lg p-6 text-center hover:border-primary-500/50 transition-colors bg-(--bg-body) min-h-[200px] flex flex-col justify-center",children:d==="youtube"?e.jsxs("div",{className:"w-full max-w-md mx-auto",children:[e.jsx("label",{className:"block text-left text-sm text-(--text-secondary) mb-1",children:"YouTube Video URL"}),e.jsx("input",{type:"url",placeholder:"https://www.youtube.com/watch?v=...",className:"w-full bg-(--bg-surface) border border-(--border-color) rounded px-3 py-2 text-(--text-main) focus:border-primary-500",value:a.metadata?.youtube_url||"",onChange:o=>c(r=>({...r,metadata:{...r.metadata,youtube_url:o.target.value}}))})]}):S?e.jsxs("div",{className:"text-(--text-secondary) flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500 mb-2"}),e.jsx("span",{children:"Uploading..."})]}):e.jsxs(e.Fragment,{children:[a.metadata?.video_url&&d==="video"&&e.jsxs("div",{className:"relative w-full max-w-md mx-auto bg-black rounded-lg overflow-hidden border border-(--border-color)",children:[e.jsx("video",{src:a.metadata.video_url,controls:!0,className:"w-full h-auto max-h-[300px]"}),e.jsx("button",{type:"button",onClick:()=>c(o=>({...o,metadata:{...o.metadata,video_url:""}})),className:"absolute top-2 right-2 bg-red-600 text-white p-1 rounded-full shadow-md z-10",children:"âœ•"})]}),a.document_url&&d==="pdf"&&e.jsxs("div",{className:"relative p-4 bg-(--bg-surface) rounded-lg border border-(--border-color) flex items-center justify-between max-w-md mx-auto w-full",children:[e.jsxs("div",{className:"flex items-center truncate",children:[e.jsx("div",{className:"text-2xl mr-3",children:"ðŸ“„"}),e.jsx("a",{href:a.document_url,target:"_blank",className:"text-sm text-primary-400 hover:underline truncate",children:a.document_url.split("/").pop()})]}),e.jsx("button",{type:"button",onClick:()=>c(o=>({...o,document_url:""})),className:"text-red-500 ml-2",children:"âœ•"})]}),d==="image"&&(a.featured_image_url||a.metadata?.gallery?.length>0)&&e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 w-full",children:[a.featured_image_url&&e.jsxs("div",{className:"relative group aspect-square rounded-lg overflow-hidden border-2 border-primary-500/50",children:[e.jsx("img",{src:a.featured_image_url,alt:"Main",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx("span",{className:"text-xs font-bold text-white",children:"Main"})}),e.jsx("button",{type:"button",onClick:()=>c(o=>({...o,featured_image_url:""})),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 opacity-100",children:"âœ•"})]}),a.metadata?.gallery?.map((o,r)=>e.jsxs("div",{className:"relative group aspect-square rounded-lg overflow-hidden border border-(--border-color)",children:[e.jsx("img",{src:o,alt:"Gallery",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>c(l=>{const t=[...l.metadata.gallery];return t.splice(r,1),{...l,metadata:{...l.metadata,gallery:t}}}),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity",children:"âœ•"})]},r))]}),!a.metadata?.video_url&&!a.document_url&&d!=="image"||d==="image"?e.jsxs("div",{className:`mt-4 ${d==="image"&&a.featured_image_url?"inline-block w-24 h-24 align-top ml-2":""}`,children:[e.jsx("input",{type:"file",className:"hidden",id:"file-upload",accept:d==="video"?"video/mp4,video/webm,video/ogg":d==="pdf"?"application/pdf":"image/*",onChange:k,disabled:d==="video"&&!!a.metadata?.video_url||d==="pdf"&&!!a.document_url,multiple:d==="image"}),e.jsx("label",{htmlFor:"file-upload",className:`cursor-pointer flex flex-col items-center justify-center transition-colors ${d==="image"&&a.featured_image_url?"w-full h-full border-2 border-dashed border-(--border-color) rounded-lg hover:bg-(--bg-surface-hover)":"inline-block px-4 py-2 bg-(--bg-surface-hover) hover:bg-(--bg-surface) rounded text-sm font-bold text-(--text-main)"}`,children:d==="image"&&a.featured_image_url?e.jsx("span",{className:"text-2xl text-(--text-secondary)",children:"+"}):e.jsx("span",{children:d==="image"&&!a.featured_image_url?"Select Images":d==="video"?"Select Video":"Select PDF"})})]}):null]})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"source",className:"block text-sm font-medium text-(--text-secondary) mb-2",children:"Source / Reference (URL or Text)"}),e.jsx("input",{type:"text",name:"source",id:"source",value:a.source,onChange:x,className:"w-full bg-(--bg-body) border border-(--border-color) rounded-lg px-4 py-3 text-(--text-main) placeholder-gray-500 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors",placeholder:"https://example.com or 'Company Internal Report'"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"content",className:"block text-sm font-medium text-(--text-secondary) mb-2",children:"Content"}),e.jsx("textarea",{name:"content",id:"content",rows:12,required:!0,value:a.content,onChange:x,className:"w-full bg-(--bg-body) border border-(--border-color) rounded-lg px-4 py-3 text-(--text-main) placeholder-gray-500 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors font-mono text-sm",placeholder:"Write your article content here (Markdown supported)..."})]}),e.jsxs("div",{className:"pt-4 border-t border-(--border-color) flex justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{const r=new URLSearchParams(window.location.search).get("returnTo")||"/";window.location.href=r},className:"mr-3 inline-flex justify-center rounded-md border border-(--border-color) bg-transparent py-3 px-8 text-sm font-medium text-(--text-secondary) shadow-sm hover:bg-(--bg-surface-hover) hover:text-(--text-main) focus:outline-none transition-all",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:_,className:`inline-flex justify-center rounded-md border border-transparent bg-primary-600 py-3 px-8 text-sm font-medium text-white shadow-sm hover:bg-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-all transform hover:scale-105 ${_?"opacity-50 cursor-not-allowed":""}`,children:_?"Saving...":a.id?"Update Post":"Publish Post"})]})]})}export{O as default};
