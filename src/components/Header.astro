---
import HeaderUserDropdown from "./HeaderUserDropdown";
import HeaderNotifications from "./HeaderNotifications";
import RecentActivity from "./RecentActivity";
import { createSupabaseServerClient } from "../lib/supabase";

interface Props {
  hideBorder?: boolean;
}

const { hideBorder = false } = Astro.props;

// Obtener profile si no está en locals (para rutas que no pasan por el middleware completo)
const locals = Astro.locals as any;

const supabase = createSupabaseServerClient({
  req: Astro.request,
  cookies: Astro.cookies,
});

// Fetch topics for Mobile Menu
const { data: topics } = (await supabase
  .from("topics")
  .select("name, slug")
  .order("name")) as { data: any[] | null };

let profile: { role?: string; profile_slug?: string } | null = locals.profile;

// Debug: Log para verificar
console.log("[Header] locals.profile:", locals.profile);
console.log("[Header] locals.user:", locals.user?.id, locals.user?.email);

if (!profile && locals.user) {
  console.log(
    "[Header] Profile no encontrado en locals, obteniendo desde Supabase...",
  );
  const supabase = createSupabaseServerClient({
    req: Astro.request,
    cookies: Astro.cookies,
  });
  // Solo obtener las columnas que existen en la tabla
  const { data: profileData, error: profileError } = await supabase
    .from("profiles")
    .select("role, full_name, avatar_url, profile_slug")
    .eq("id", locals.user.id)
    .single();

  console.log("[Header] Profile query result:", { profileData, profileError });

  if (profileError) {
    console.error("[Header] Error obteniendo profile:", profileError);
  }

  if (profileData) {
    profile = {
      role: (profileData as any).role || undefined,
      profile_slug: (profileData as any).profile_slug || undefined,
    };
    console.log("[Header] Profile obtenido:", profile);
  } else {
    console.warn("[Header] Profile data no válido:", profileData);
  }
} else if (profile) {
  console.log("[Header] Profile encontrado en locals:", profile);
}
---

<header
  class={`fixed top-0 left-0 z-1000 w-full transition-all duration-300 ${hideBorder ? "" : "border-b border-(--border-color)"}`}
  id="main-header"
  style="height: 70px; min-height: 70px; max-height: 70px; box-sizing: border-box;"
>
  <div
    class="flex h-full items-center justify-between w-full px-4 sm:px-6 lg:px-8"
    style="background-color: #0d241b;"
  >
    {/* --- MOBILE LEFT: Grid Toggle + Notifications --- */}
    <div class="flex md:hidden items-center gap-4 shrink-0">
      {/* Grid Toggle (Opens Sidebar) */}
      <button
        type="button"
        id="mobile-sidebar-toggle"
        class="text-white hover:text-[#00c54f] transition-colors"
        aria-label="Open Menu"
      >
        <span class="material-icons text-[28px]">apps</span>
      </button>

      {/* Notifications */}
      <a
        href="/notifications"
        class="text-white hover:text-[#00c54f] transition-colors relative"
      >
        <span class="material-icons text-[24px]">notifications_none</span>
        <span
          class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-600 ring-2 ring-primary-500"
        ></span>
      </a>
    </div>

    {/* --- DESKTOP LEFT: Logo --- */}
    <div class="hidden md:flex items-center shrink-0 gap-6">
      <a href="/">
        <img
          src="/ZVENIA-Mining-Logo.svg"
          alt="ZVENIA Mining"
          class="w-full"
          style="max-height: 45px; height: auto;"
        />
      </a>
      {Astro.locals.user && <RecentActivity client:load />}
    </div>

    {/* --- CENTER: Logo (Mobile Only actually? Or shared?) --- */}
    {
      /* The user wants Center Logo. Existing code had responsive logic. Let's keep one center logo. */
    }
    <div class="flex flex-1 justify-center items-center">
      {
        /* Desktop Center Logo is usually hidden if Left Logo exists, but current code shows both?
                 Let's look at current: Block 1 is Left Logo. Block 2 is Center Logo.
                 For Mobile: We want strictly Center Logo.
             */
      }
      <a href="/" class="block">
        <img
          src="/zvenia-Logo.svg"
          alt="ZVENIA"
          class="h-[32px] md:h-[40px] w-auto"
        />
      </a>
    </div>

    {/* --- MOBILE RIGHT: Plus + Profile --- */}
    <div class="flex md:hidden items-center gap-3 shrink-0">
      {/* New Post Button */}
      <a
        href="/dashboard/create"
        class="flex items-center justify-center w-8 h-8 bg-[#00c54f] hover:bg-[#00a843] rounded-sm text-white shadow-sm"
      >
        <span class="material-icons text-[20px] font-bold">add</span>
      </a>

      {/* Profile Avatar / Menu */}
      {
        (() => {
          const locals = Astro.locals as any;
          const user = locals.user;
          // Ensure role logic matches desktop
          const userRole =
            profile?.role ||
            (user?.role && user?.role !== "authenticated"
              ? user?.role
              : null) ||
            null;

          return (
            <div class="scale-90 origin-right">
              <HeaderUserDropdown
                client:load
                user={{
                  email: user?.email || "",
                  first_name: user?.first_name || null,
                  last_name: user?.last_name || null,
                  full_name: user?.full_name || null,
                  avatar_url: user?.avatar_url || null,
                  role: userRole,
                }}
                profile={
                  profile
                    ? { role: profile.role, profile_slug: profile.profile_slug }
                    : null
                }
              />
            </div>
          );
        })()
      }
    </div>

    {/* --- DESKTOP RIGHT: Actions --- */}
    <div class="hidden md:flex items-center justify-end shrink-0 gap-x-6">
      {
        Astro.locals.user ? (
          <div class="flex items-center gap-4">
            <a
              href="/dashboard/create"
              class="flex items-center justify-center w-10 h-10 bg-[#00c54f] hover:bg-[#00a843] transition-colors text-white shadow-sm"
              title="Create New Post"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
            </a>
            {(() => {
              const locals = Astro.locals as any;
              const user = locals.user;
              const userRole =
                profile?.role ||
                (user?.role && user?.role !== "authenticated"
                  ? user?.role
                  : null) ||
                null;

              return (
                <HeaderUserDropdown
                  client:load
                  user={{
                    email: user?.email || "",
                    first_name: user?.first_name || null,
                    last_name: user?.last_name || null,
                    full_name: user?.full_name || null,
                    avatar_url: user?.avatar_url || null,
                    role: userRole,
                  }}
                  profile={
                    profile
                      ? {
                          role: profile.role,
                          profile_slug: profile.profile_slug,
                        }
                      : null
                  }
                />
              );
            })()}
          </div>
        ) : (
          <>
            <a
              href="/login"
              class="text-sm font-semibold leading-6 text-white hover:text-primary-400 transition-colors"
            >
              Log In
            </a>
            <a
              href="/register"
              class="rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-black shadow-sm transition-colors"
            >
              Register
            </a>
          </>
        )
      }
    </div>
  </div>
</header>
{
  /* Left Sidebar Script is handled in SocialLayout, but we emit event if needed.
    Since we used ID 'mobile-sidebar-toggle', SocialLayout can listen to it.
*/
}
