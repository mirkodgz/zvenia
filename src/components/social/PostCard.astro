---
import { PdfViewer } from './PdfViewer';
import PostOptions from './PostOptions';
import SocialFooter from './SocialFooter';
import FollowButton from './FollowButton';

interface Props {
    post: any;
    currentUser: any;
    isDetail?: boolean;
}

const { post, currentUser, isDetail = false } = Astro.props;

const formatDate = (dateStr: string | null) => {
    if(!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Helper to clean content logic (same as Topic page)
const getCleanContent = (item: any) => {
    const raw = item.content || item.excerpt || item.description || '';
    if (!raw) return '';
    return raw
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/<\/p>/gi, '\n\n')
        .replace(/<\/div>/gi, '\n')
        .replace(/<li>/gi, '• ')
        .replace(/<\/li>/gi, '\n')
        .replace(/<[^>]*>?/gm, '') // Strip remaining tags
        .replace(/&nbsp;/g, ' ')
        .trim();
};
---

<article class="bg-[var(--bg-surface)] rounded-lg border border-[var(--border-color)] overflow-hidden hover:border-primary-500/20 transition-colors animate-fade-in">
    
    <!-- 1. Header: Author, Date, Options -->
    <div class="p-4 flex gap-3 items-start justify-between">
            <div class="flex gap-3 items-center">
                <!-- Avatar -->
                <a href={`/in/${post.author_id}`} class="block flex-shrink-0">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 border border-[var(--border-color)] flex items-center justify-center text-sm font-bold text-white overflow-hidden hover:opacity-80 transition-opacity">
                        {post.author?.avatar_url ? (
                            <img src={post.author.avatar_url} class="w-full h-full object-cover"/>
                        ) : (
                            (post.author?.full_name?.[0] || post.author_name?.[0] || 'U')
                        )}
                    </div>
                </a>
                
                <!-- Meta -->
                <div>
                    <div class="flex items-center gap-2">
                        <a href={`/in/${post.author_id}`} class="block group">
                            <h3 class="text-sm font-bold text-[var(--text-main)] group-hover:text-primary-400 cursor-pointer flex items-center gap-1 transition-colors">
                            {post.author?.full_name || post.author_name || 'Unknown Author'}
                            <span class="text-blue-400 text-[10px]">✓</span> 
                            </h3>
                        </a>
                        <FollowButton client:load targetUserId={post.author_id} currentUserId={currentUser?.id} />
                    </div>
                    <p class="text-xs text-[var(--text-secondary)]">
                    {post.author?.profession ? `${post.author.profession} • ` : ''} 
                    {formatDate(post.published_at || post.created_at)}
                    </p>
                </div>
            </div>

            <!-- Menu (Edit/Delete) -->
            <PostOptions 
                client:visible 
                postId={post.id} 
                authorId={post.author_id} 
                currentUserId={currentUser?.id}
                slug={post.slug}
            />
    </div>

    <!-- 2. Body: Content -->
    <div class="px-4 pb-2">
        {/* Breadcrumb if Topic */}
        {post.topic && (
            <a href={`/mining/${post.topic.slug}`} class="inline-block text-[10px] uppercase tracking-wider font-bold text-gray-500 hover:text-primary-400 mb-2 transition-colors">
                # {post.topic.name}
            </a>
        )}

        {isDetail ? (
             <h1 class="text-2xl font-bold text-blue-400 mb-2">{post.title}</h1>
        ) : (
            <a href={`/post/${post.slug || post.id}`} class="block group">
                <h4 class="text-base font-bold text-blue-400 mb-1 group-hover:underline cursor-pointer transition-colors">{post.title}</h4>
            </a>
        )}
        
        <p class={`post-content text-sm text-[var(--text-main)] opacity-80 leading-relaxed mb-3 transition-all duration-300 whitespace-pre-wrap ${!isDetail ? 'line-clamp-3' : ''}`}>
            {getCleanContent(post)}
        </p>

        {!isDetail && (
            <button class="read-more-btn text-xs text-blue-400 hover:text-blue-300 mb-4 block text-right">...read more</button>
        )}
        
        {post.source && (
            <div class="mb-3 text-sm">
                {post.source.startsWith('http') ? (
                    <a href={post.source} target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline break-all truncate block">
                        {post.source}
                    </a>
                ) : (
                    <span class="text-gray-400 italic">Source: {post.source}</span>
                )}
            </div>
        )}
    </div>

    <!-- 3. Media: PDF or Gallery -->
    <!-- 3. Media: YouTube, Video, PDF, or Gallery -->
    {(() => {
        const youtubeUrl = post.metadata?.youtube_url;
        const videoUrl = post.metadata?.video_url;

        // 3.1 YouTube
        if(youtubeUrl) {
            // Extract ID
            let videoId = '';
            try {
                if(youtubeUrl.includes('youtube.com/watch')) {
                    videoId = new URL(youtubeUrl).searchParams.get('v') || '';
                } else if(youtubeUrl.includes('youtu.be/')) {
                    videoId = youtubeUrl.split('youtu.be/')[1].split('?')[0];
                }
            } catch(e) {}

            if(videoId) {
                return (
                    <div class="w-full aspect-video bg-black border-t border-b border-white/5">
                        <iframe 
                            width="100%" 
                            height="100%" 
                            src={`https://www.youtube.com/embed/${videoId}`} 
                            title="YouTube video player" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                        </iframe>
                    </div>
                );
            }
        }

        // 3.2 Native Video
        if(videoUrl) {
            return (
                <div class="w-full bg-black border-t border-b border-white/5">
                    <video controls class="w-full max-h-[500px]">
                        <source src={videoUrl} type="video/mp4" />
                        Your browser does not support the video tag.
                    </video>
                </div>
            )
        }

        // 3.3 PDF
        if (post.document_url) {
            return (
                <div class="px-4 pb-4">
                    <PdfViewer client:only="react" url={`/api/pdf-proxy?url=${encodeURIComponent(post.document_url)}`} />
                </div>
            );
        }

        // 3.4 Image / Gallery
        const gallery = post.metadata?.gallery || [];
        const allImages = [post.featured_image_url, ...gallery].filter(Boolean);
        
        if (allImages.length === 0) return null;

        if (allImages.length === 1) {
            return (
                <div class="w-full h-80 bg-black border-t border-b border-white/5">
                    <img src={allImages[0]} alt={post.title} class="w-full h-full object-cover" loading="lazy" />
                </div>
            );
        }

        return (
            <div class="relative w-full h-[400px] bg-black border-t border-b border-white/5 group carousel-container">
                {/* Images Container */}
                <div class="w-full h-full flex overflow-x-auto snap-x snap-mandatory scrollbar-hide scroll-smooth carousel-track">
                    {allImages.map((img: string, idx: number) => (
                        <div class="w-full h-full flex-shrink-0 snap-center relative">
                            <img src={img} alt={`${post.title} - ${idx + 1}`} class="w-full h-full object-contain bg-black" loading="lazy" />
                            <div class="absolute bottom-4 right-4 bg-black/60 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm">
                                {idx + 1} / {allImages.length}
                            </div>
                        </div>
                    ))}
                </div>

                {/* Navigation Buttons */}
                <button class="absolute left-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0 nav-prev">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button class="absolute right-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0 nav-next">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        );
    })()}

    <!-- 4. Footer: Actions -->
    <SocialFooter 
        client:visible
        postId={post.id}
        postSlug={post.slug}
        postTitle={post.title}
        likesCount={post.likes_count || 0}
        commentsCount={post.comments_count || 0}
        currentUserId={currentUser?.id}
    />
</article>
<script>
    // Self-contained logic for this component instances
    document.addEventListener('astro:page-load', () => {
         // Re-attach listeners on navigation
         attachListeners();
    });
    
    // Initial load
    document.addEventListener('DOMContentLoaded', attachListeners);
    
    // Expose for dynamic content (pagination)
    window.attachListeners = attachListeners;

    function attachListeners() {
        // Read More Logic
        const readMoreBtns = document.querySelectorAll('.read-more-btn');
        readMoreBtns.forEach(btn => {
            if(btn.hasAttribute('data-bound')) return;
            btn.setAttribute('data-bound', 'true');
            btn.addEventListener('click', (e) => {
                const button = e.target as HTMLButtonElement;
                const container = button.closest('div');
                const text = container?.querySelector('.post-content');
                if (text) {
                    text.classList.toggle('line-clamp-3');
                    button.textContent = text.classList.contains('line-clamp-3') ? '...read more' : 'Show less';
                }
            });
        });


        // Carousel Logic
        const carousels = document.querySelectorAll('.carousel-container');
        carousels.forEach(container => {
            if(container.hasAttribute('data-bound')) return;
            container.setAttribute('data-bound', 'true');

            const track = container.querySelector('.carousel-track') as HTMLElement;
            const prevBtn = container.querySelector('.nav-prev') as HTMLButtonElement;
            const nextBtn = container.querySelector('.nav-next') as HTMLButtonElement;

            if(!track || !prevBtn || !nextBtn) return;

            const scrollAmount = () => track.clientWidth;

            prevBtn.addEventListener('click', () => {
                track.scrollBy({ left: -scrollAmount(), behavior: 'smooth' });
            });

            nextBtn.addEventListener('click', () => {
                track.scrollBy({ left: scrollAmount(), behavior: 'smooth' });
            });
        });
    }
</script>
