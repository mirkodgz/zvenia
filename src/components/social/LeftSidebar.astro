---
import { supabase } from "../../lib/supabase";

interface Props {
    activeTopicSlug?: string | null;
}

const { activeTopicSlug } = Astro.props;

// Fetch Topics
const { data: topics, error } = (await supabase
    .from("topics")
    .select("*")
    .order("name")) as { data: any[]; error: any };

if (error) {
    console.error("Error fetching topics:", error);
}

// Mock User Data (Replace with Auth later)
const currentUser = Astro.locals.user;
const user = {
    name:
        currentUser?.user_metadata?.full_name ||
        currentUser?.email ||
        "Guest User",
    headline: "Mining Professional", // Placeholder for now
    avatar: currentUser?.user_metadata?.avatar_url || null,
    initial: (currentUser?.email?.[0] || "G").toUpperCase(),
};
const { slug: currentSlug } = Astro.params;
const pathname = Astro.url.pathname;
---

<div class="bg-[#dedede] min-h-full">
    <ul class="flex flex-col text-[var(--neutral)] text-sm tracking-normal">
        <!-- HOME LINK -->
        <li class="border-b border-[var(--neutral)]">
            <a
                href="/"
                class={`flex items-center gap-2 px-4 py-3 transition-colors whitespace-nowrap overflow-hidden text-ellipsis ${pathname === "/" ? "bg-[#00c44b] font-bold" : "hover:bg-[#9fdbb6]"}`}
            >
                <span class="material-icons" style="font-size: 16px; line-height: 1; width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center;">home</span>
                Home
            </a>
        </li>

        <!-- MY ZVENIA LINK -->
        <li class="border-b border-[var(--neutral)]">
            <a
                href="/my-zvenia"
                class={`flex items-center gap-2 px-4 py-3 transition-colors whitespace-nowrap overflow-hidden text-ellipsis ${pathname === "/my-zvenia" ? "bg-[#00c44b] font-bold" : "hover:bg-[#9fdbb6]"}`}
            >
                <span class="material-icons" style="font-size: 16px; line-height: 1; width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center;">layers</span>
                MY ZVENIA
            </a>
        </li>

        <!-- DYNAMIC TOPICS -->
        {
            topics?.map((topic) => {
                // Active if: 1) We're on the topic page, OR 2) We're viewing a post from this topic
                const isActive = currentSlug === topic.slug || activeTopicSlug === topic.slug;
                return (
                    <li class="border-b border-[var(--neutral)]">
                        <a
                            href={`/mining/${topic.slug}`}
                            class={`block px-4 py-3 transition-colors whitespace-nowrap overflow-hidden text-ellipsis ${isActive ? "bg-[#00c44b] font-medium" : "hover:bg-[#9fdbb6]"}`}
                        >
                            {topic.name}
                        </a>
                    </li>
                );
            })
        }
    </ul>
</div>
