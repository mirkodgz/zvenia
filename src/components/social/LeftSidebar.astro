---
import { supabase } from "../../lib/supabase";

interface Props {
    activeTopicSlug?: string | null;
}

const { activeTopicSlug } = Astro.props;

// 1. Dynamic Icon Loading
const allIcons = import.meta.glob<{ default: ImageMetadata }>(
    "../../assets/*.webp",
    { eager: true },
);

// Helper to match icon
const getIconForTopic = (topicName: string) => {
    // "01 General Mining" -> "General Mining"
    const cleanName = topicName.replace(/^\d+\s+/, "").trim();

    // "General Mining" -> "general-mining"
    const slugName = cleanName.replace(/\s+/g, "-").toLowerCase();

    // Find matching file
    const matchPath = Object.keys(allIcons).find((path) => {
        const fileName = path.split("/").pop()?.split(".")[0].toLowerCase();
        // Match exact or with "icon-" prefix (legacy)
        return fileName === slugName || fileName === `icon-${slugName}`;
    });

    return matchPath ? allIcons[matchPath].default : null;
};

// Fetch Topics
const { data: topics, error } = (await supabase
    .from("topics")
    .select("*")
    .order("name")) as { data: any[]; error: any };

if (error) {
    console.error("Error fetching topics:", error);
}

// Mock User Data (Replace with Auth later)
const currentUser = Astro.locals.user;
const user = {
    name:
        currentUser?.user_metadata?.full_name ||
        currentUser?.email ||
        "Guest User",
    headline: "Mining Professional", // Placeholder for now
    avatar: currentUser?.user_metadata?.avatar_url || null,
    initial: (currentUser?.email?.[0] || "G").toUpperCase(),
};
const { slug: currentSlug } = Astro.params;
const pathname = Astro.url.pathname;
---

<div class="bg-[#dedede] min-h-full border-r border-[#cbcbcb]">
    <nav class="p-4 space-y-1">
        <!-- HOME LINK -->
        <a
            href="/"
            class={`flex items-center gap-3 px-4 py-2 rounded-none transition-colors ${pathname === "/" ? "bg-white text-accent-500 font-medium shadow-sm" : "text-gray-700 hover:bg-[#00c54f]/20"}`}
        >
            <span class="material-icons text-[20px]">home</span>
            <span class="font-medium">Home</span>
        </a>

        <!-- MY ZVENIA LINK -->
        {
            currentUser && (
                <a
                    href="/my-zvenia"
                    class={`flex items-center gap-3 px-4 py-2 rounded-none transition-colors ${pathname === "/my-zvenia" ? "bg-white text-accent-500 font-medium shadow-sm" : "text-gray-700 hover:bg-[#00c54f]/20"}`}
                >
                    <span class="material-icons text-[20px]">layers</span>
                    <span class="font-medium">MY ZVENIA</span>
                </a>
            )
        }

        <hr class="my-2 border-[#cbcbcb]" />

        <!-- DYNAMIC TOPICS -->
        {
            topics?.map((topic, index) => {
                const isActive =
                    currentSlug === topic.slug ||
                    activeTopicSlug === topic.slug;

                // Extract number prefix if present (e.g. "01 General")
                const match = topic.name.match(/^(\d+)\s+(.+)$/);
                const number = match ? match[1] : null;
                const name = match ? match[2] : topic.name;

                // Dynamic Icon
                const customIcon = getIconForTopic(topic.name);

                return (
                    <a
                        href={`/mining/${topic.slug}`}
                        class={`flex items-center gap-3 px-4 py-2 rounded-none transition-colors group border-b border-black/10 last:border-0 ${isActive ? "bg-white text-accent-500 font-medium shadow-sm" : "text-gray-700 hover:bg-[#00c54f]/20"}`}
                    >
                        {customIcon ? (
                            <img
                                src={customIcon.src}
                                alt={name}
                                class="w-6 h-6 object-contain"
                            />
                        ) : number ? (
                            <span
                                class={`text-sm font-mono ${isActive ? "text-accent-500" : "text-gray-500 group-hover:text-gray-700"}`}
                            >
                                {number}
                            </span>
                        ) : (
                            <span class="material-icons text-[20px]">
                                folder
                            </span>
                        )}
                        <span class="font-medium truncate">{name}</span>
                    </a>
                );
            })
        }
    </nav>
</div>
