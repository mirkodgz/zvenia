---
import { MapPin } from "lucide-react";
import CountryManagersWidget from "./CountryManagersWidget.astro";

const { country, supabase, user } = Astro.locals;

// Define types explicitly to avoid 'never' or 'any' implicit issues
interface Ad {
    id: number;
    title: string;
    image_url: string;
    link_url: string;
    location: string | null;
}

// 1. Determine Location (IP > Profile Fallback)
let detectedCountryCode = country || null;
let detectedCountryName = null;

// Fallback: If no IP country, check logged-in user's profile country
if (!detectedCountryCode && user) {
    const userCountry = (user as any).country;
    if (userCountry) {
        if (userCountry.length === 2) {
            detectedCountryCode = userCountry; // It's a code like 'IT'
        } else {
            detectedCountryName = userCountry; // It's a name like 'Italy'
        }
    }
}

// 2. Resolve to a Country Name (ADS use Names like 'Italy', not codes like 'IT')
if (detectedCountryCode) {
    // Get Display Name from Code
    const { data: countryData } = await supabase
        .from("countries")
        .select("display_name")
        .eq("code", detectedCountryCode)
        .single();

    // Explicitly check for data existance and property
    const display_name = (countryData as any)?.display_name;
    if (display_name) {
        detectedCountryName = display_name;
    }
}

// 3. Fetch Promoted Ads (Filtered by Location)
let ads: Ad[] = [];

if (detectedCountryName) {
    const { data: adsVal } = await supabase
        .from("ads")
        .select("*")
        .eq("location", detectedCountryName) // Strict filtering
        .order("created_at", { ascending: false })
        .limit(2);

    ads = (adsVal || []) as Ad[];
} else {
    // Optional: If absolutely no location is known (very rare logged out),
    // maybe show Global ads? For now, we show strictly targeted or nothing matching the strict requirement.
    // If you want a global fallback, we could query ads where location is null or 'Global'.
    // ads = [];
}
---

<aside class="hidden lg:block w-full shrink-0 space-y-6">
    {/* Country Managers Widget */}
    <CountryManagersWidget />

    {/* Promoted Section */}
    <div class="bg-white border border-(--border-color) p-4 shadow-sm">
        <h3 class="font-bold text-lg mb-4 text-(--text-main)">Promoted</h3>

        <div class="space-y-4">
            {
                ads && ads.length > 0 ? (
                    ads.map((ad) => (
                        <a
                            href={ad.link_url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="block group"
                        >
                            <div class="aspect-video overflow-hidden bg-(--bg-surface-hover) mb-2 relative">
                                {ad.image_url ? (
                                    <img
                                        src={ad.image_url}
                                        alt={ad.title}
                                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                    />
                                ) : (
                                    <div class="w-full h-full flex items-center justify-center text-(--text-secondary)">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-8 w-8"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                            />
                                        </svg>
                                    </div>
                                )}
                            </div>
                            <h4 class="font-bold text-(--text-main) group-hover:text-accent-500 transition-colors leading-tight">
                                {ad.title}
                            </h4>
                            <p class="text-xs text-(--text-secondary) mt-1 line-clamp-2 flex items-center gap-1">
                                {ad.location && (
                                    <>
                                        <MapPin className="w-3 h-3 text-accent-500" />
                                        <span>{ad.location}</span>
                                    </>
                                )}
                            </p>
                        </a>
                    ))
                ) : (
                    <div class="flex flex-col items-center justify-center text-center py-6 px-4 bg-gray-50 border border-dashed border-gray-300">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mb-3 text-gray-400">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-6 h-6"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"
                                />
                            </svg>
                        </div>
                        <h4 class="text-sm font-bold text-gray-900 mb-1">
                            Promote your business
                        </h4>
                        <p class="text-xs text-gray-500 mb-4 max-w-[200px] leading-relaxed">
                            Reach professionals in{" "}
                            {detectedCountryName || "your area"} effectively.
                        </p>
                        <a
                            href="/my-zvenia?tab=ads"
                            class="inline-flex items-center gap-2 text-xs font-bold text-accent-500 hover:text-accent-600 bg-white border border-gray-200 px-4 py-2 rounded-md shadow-sm hover:shadow-md transition-all uppercase tracking-wide"
                        >
                            Start Now
                        </a>
                    </div>
                )
            }
        </div>
    </div>
</aside>
