---
// import { supabase } from "@/lib/supabase"; // Don't use browser client on server

const { country, supabase } = Astro.locals;
// Default to a known country if not detected (e.g., for testing or fallback) or handle gracefully
const detectedCountryCode = country || null;

let countryManager = null;
let countryName = "your country";

// Define types explicitly to avoid 'never' or 'any' implicit issues
interface CountryData {
    id: number;
    display_name: string;
}

interface ManagerProfile {
    id: string;
    full_name: string;
    avatar_url: string | null;
    profile_slug: string | null;
}

if (detectedCountryCode) {
    // 1. Get Country ID from ISO code
    const { data: countryDataVal } = await supabase
        .from("countries")
        .select("id, display_name")
        .eq("code", detectedCountryCode)
        .single();

    // Cast to our explicit type or null
    const countryData = countryDataVal as CountryData | null;

    if (countryData) {
        countryName = countryData.display_name;

        // 2. Get Country Manager profile
        const { data: managerVal } = await supabase
            .from("profiles")
            .select("*")
            .eq("country", countryData.display_name) // Match by Country (Origin) as requested
            .eq("role", "CountryManager") // Ensure we only get active Managers
            .single(); // Assuming one per country for now, or take the first one

        // Cast to our explicit type or null
        const manager = managerVal as unknown as ManagerProfile | null;

        if (manager) {
            countryManager = manager;
        }
    }
} else {
    // Optional: Fetch a default/highlighted manager if no country detected?
    // For now we'll stick to the "Become a Manager" CTA which is safer.
}
---

<div class="bg-white border border-(--border-color) p-4 shadow-sm">
    <h3
        class="font-bold text-lg mb-4 text-(--text-main) flex items-center gap-2"
    >
        Country Manager
    </h3>
    {
        countryManager ? (
            <div class="relative group">
                {/* External Link Icon (Absolute Top-Right of the card content) */}
                <a
                    href={`/profile/${countryManager.profile_slug}`}
                    class="absolute top-0 right-0 p-1 text-gray-400 hover:text-primary-500 transition-colors"
                    title="View Profile"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                        />
                    </svg>
                </a>

                <div class="flex items-center gap-4">
                    <a
                        href={`/profile/${countryManager.profile_slug}`}
                        class="shrink-0"
                    >
                        {countryManager.avatar_url ? (
                            <img
                                src={countryManager.avatar_url}
                                alt={countryManager.full_name}
                                class="w-14 h-14 rounded-none object-cover ring-2 ring-transparent group-hover:ring-accent-500 transition-all"
                            />
                        ) : (
                            <img
                                src="/igm-default.webp"
                                alt={countryManager.full_name}
                                class="w-14 h-14 rounded-none object-cover ring-2 ring-transparent group-hover:ring-accent-500 transition-all opacity-80"
                            />
                        )}
                    </a>

                    <div class="flex-1 min-w-0 pr-6">
                        {" "}
                        {/* pr-6 to avoid overlapping with icon */}
                        <a
                            href={`/profile/${countryManager.profile_slug}`}
                            class="block"
                        >
                            <h4 class="font-bold text-[15px] text-(--text-main) group-hover:text-accent-500 transition-colors leading-tight truncate">
                                {countryManager.full_name}
                            </h4>
                        </a>
                        <p class="text-sm text-(--text-secondary) mt-0.5">
                            {countryName}
                        </p>
                    </div>
                </div>
            </div>
        ) : (
            <div class="flex flex-col items-center justify-center text-center py-4 px-2 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                <div class="w-10 h-10 bg-gray-200 rounded-none flex items-center justify-center mb-3 text-gray-400">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        />
                    </svg>
                </div>
                <p class="text-sm text-gray-900 font-medium mb-1">
                    No Manager in {countryName}
                </p>
                <p class="text-xs text-gray-500 mb-3">
                    This position is currently open.
                </p>
                <a
                    href="/join"
                    class="text-xs font-semibold text-primary-600 hover:text-primary-700 bg-white border border-gray-200 px-3 py-1.5 rounded shadow-sm hover:shadow transition-all"
                >
                    Apply Now
                </a>
            </div>
        )
    }

    {/* DEBUG OVERLAY (Only visible with ?debug_geo=true) */}
    {
        Astro.url.searchParams.get("debug_geo") === "true" && (
            <div class="mt-2 p-2 bg-black/90 text-green-400 text-xs font-mono rounded overflow-hidden">
                <p>
                    <strong>Locals.country:</strong>{" "}
                    {Astro.locals.country || "undefined"}
                </p>
                <p>
                    <strong>GEO Header:</strong> {detectedCountryCode || "NONE"}
                </p>
                <p>
                    <strong>Resolved Name:</strong> {countryName || "N/A"}
                </p>
                <p>
                    <strong>Manager Found:</strong>{" "}
                    {countryManager ? "YES" : "NO"}
                </p>
                {countryManager && (
                    <p>
                        <strong>Manager Name:</strong>{" "}
                        {countryManager.full_name}
                    </p>
                )}
            </div>
        )
    }
</div>
