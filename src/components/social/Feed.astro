---
import { createSupabaseServerClient } from "../../lib/supabase";
import CreateContentModal from "../dashboard/CreateContentModal";
import PostCard from "./PostCard.astro";
import PodcastRow from "./PodcastRow";
import EventCard from "./EventCard";
import ServiceCard from "./ServiceCard";

// ... (existing imports)

const { filter = "popular" } = Astro.props; // 'popular' | 'saved'

// 1. Get Feed Type from URL
const feedType = Astro.url.searchParams.get("feed") || "post";

// 2. Fetch User Saved Items (if logged in)
const currentUser = Astro.locals.user;
let savedItemIds = new Set<string>();

const supabase = createSupabaseServerClient({
    req: Astro.request,
    cookies: Astro.cookies,
});

if (currentUser) {
    const { data: savedItems, error: savedError } = await supabase
        .from("saved_items")
        .select("item_id")
        .eq("user_id", currentUser.id)
        .eq("item_type", feedType);

    if (savedItems) {
        (savedItems as any[]).forEach((item) => savedItemIds.add(item.item_id));
    }
}

// 3. Polymorphic Fetching
let data: any[] = [];
let error = null;

// If filtering by saved items and user has none, we can skip fetching
if (filter === "saved" && savedItemIds.size === 0) {
    data = [];
} else {
    if (feedType === "post") {
        let query = supabase
            .from("posts")
            .select(
                `*, author:profiles(full_name, avatar_url, profession, company, profile_slug), topic:topics(name, slug)`,
            );

        if (filter === "saved") {
            query = query.in("id", Array.from(savedItemIds));
        } else {
            // Default: Popular
            query = query.eq("is_popular", true);
        }

        const { data: posts, error: err } = await query
            .order("published_at", { ascending: false })
            .limit(20);
        data = posts || [];
        error = err;
    } else if (feedType === "event") {
        const now = new Date().toISOString();
        let query = supabase.from("events").select("*");

        if (filter === "saved") {
            query = query.in("id", Array.from(savedItemIds));
        } else {
            query = query
                .eq("is_popular", true)
                .or(`end_date.gte.${now},start_date.gte.${now}`);
        }

        const { data: events, error: err } = await query
            .order("created_at", { ascending: false })
            .limit(50);
        data = events || [];
        error = err;
    } else if (feedType === "podcast") {
        let query = supabase.from("podcasts").select("*");

        if (filter === "saved") {
            query = query.in("id", Array.from(savedItemIds));
        } else {
            query = query.eq("is_popular", true);
        }

        const { data: podcasts, error: err } = await query
            .order("created_at", { ascending: false })
            .limit(20);
        data = podcasts || [];
        error = err;
    } else if (feedType === "service") {
        let query = supabase.from("services").select("*");

        if (filter === "saved") {
            query = query.in("id", Array.from(savedItemIds));
        } else {
            query = query.eq("is_popular", true);
        }

        const { data: services, error: err } = await query
            .order("created_at", { ascending: false })
            .limit(20);
        data = services || [];
        error = err;
    }
}

if (error) {
    console.error(`Error fetching ${feedType} feed:`, error);
}

// Helper: Date Format
const formatDate = (dateStr: string | null) => {
    if (!dateStr) return "";
    return new Date(dateStr).toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
    });
};
---

<div class="w-full mx-auto pb-20">
    <!-- Header / Creator -->
    {
        Astro.locals.user && (
            <CreateContentModal
                client:load
                currentUser={Astro.locals.user}
                userInitials={
                    Astro.locals.user.email?.charAt(0).toUpperCase() || "U"
                }
                activeFeed={feedType}
            />
        )
    }

    <!-- Feed Label -->
    <div
        class={feedType === "podcast"
            ? "flex justify-between items-center mb-4 w-full mx-auto"
            : feedType === "post"
              ? "flex justify-between items-center mb-4 max-w-[600px] mx-auto px-2"
              : "flex justify-between items-center px-4 mb-4"}
    >
        <h3
            class="text-(--text-main) font-bold text-lg capitalize flex items-center gap-2"
        >
            {
                feedType === "post" && (
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5 text-primary-400"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <>
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                            <line x1="10" y1="9" x2="8" y2="9" />
                        </>
                    </svg>
                )
            }
            {
                feedType === "event" && (
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5 text-primary-400"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <>
                            <rect
                                x="3"
                                y="4"
                                width="18"
                                height="18"
                                rx="2"
                                ry="2"
                            />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </>
                    </svg>
                )
            }
            {
                feedType === "podcast" && (
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5 text-primary-400"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <>
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                            <line x1="12" y1="19" x2="12" y2="23" />
                            <line x1="8" y1="23" x2="16" y2="23" />
                        </>
                    </svg>
                )
            }
            {
                feedType === "service" && (
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5 text-primary-400"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <>
                            <rect
                                x="2"
                                y="7"
                                width="20"
                                height="14"
                                rx="2"
                                ry="2"
                            />
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                        </>
                    </svg>
                )
            }

            {
                feedType === "post" &&
                    (filter === "saved" ? "Saved Posts" : "Popular Posts")
            }
            {
                feedType === "event" &&
                    (filter === "saved" ? "Saved Events" : "Upcoming Events")
            }
            {
                feedType === "podcast" &&
                    (filter === "saved" ? "Saved Podcasts" : "Recent Podcasts")
            }
            {
                feedType === "service" &&
                    (filter === "saved"
                        ? "Saved Services"
                        : "Professional Services")
            }
        </h3>
        <span class="text-xs text-gray-500"
            >Sorted by: <span class="font-bold text-(--text-main)">Newest</span
            ></span
        >
    </div>

    <!-- Empty State -->
    {
        data.length === 0 && (
            <div class="text-center py-16 bg-[#1A1A1A] border border-white/10 mx-4">
                <div class="mb-4 opacity-20 flex justify-center">
                    {feedType === "post" && (
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-16 h-16 text-white"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                            <line x1="10" y1="9" x2="8" y2="9" />
                        </svg>
                    )}
                    {feedType === "event" && (
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-16 h-16 text-white"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <rect
                                x="3"
                                y="4"
                                width="18"
                                height="18"
                                rx="2"
                                ry="2"
                            />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>
                    )}
                    {feedType === "podcast" && (
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-16 h-16 text-white"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                            <line x1="12" y1="19" x2="12" y2="23" />
                            <line x1="8" y1="23" x2="16" y2="23" />
                        </svg>
                    )}
                    {feedType === "service" && (
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-16 h-16 text-white"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <rect
                                x="2"
                                y="7"
                                width="20"
                                height="14"
                                rx="2"
                                ry="2"
                            />
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                        </svg>
                    )}
                </div>
                <h3 class="text-xl font-bold text-white mb-2">
                    No {feedType}s found
                </h3>
                <p class="text-gray-400 text-sm">Be the first to create one!</p>
            </div>
        )
    }

    <!-- FEED RENDERER -->
    <div
        class={feedType === "event" || feedType === "service"
            ? "grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto"
            : feedType === "podcast"
              ? "space-y-4 w-full"
              : "space-y-4 px-0 md:px-2 max-w-[600px] mx-auto"}
    >
        {/* POSTS */}
        {
            feedType === "post" &&
                data.map((item) => (
                    <PostCard
                        post={item}
                        currentUser={Astro.locals.user}
                        initialIsSaved={savedItemIds.has(item.id)}
                    />
                ))
        }

        {/* EVENTS */}
        {
            feedType === "event" &&
                data.map((item) => (
                    <EventCard
                        client:load
                        event={item}
                        currentUser={Astro.locals.user}
                        initialIsSaved={savedItemIds.has(item.id)}
                    />
                ))
        }

        {/* PODCASTS */}
        {
            feedType === "podcast" &&
                data.map((item) => (
                    <PodcastRow
                        client:load
                        podcast={item}
                        currentUser={Astro.locals.user}
                        initialIsSaved={savedItemIds.has(item.id)}
                    />
                ))
        }

        {/* SERVICES */}
        {
            feedType === "service" &&
                data.map((item) => (
                    <ServiceCard
                        client:load
                        service={item}
                        currentUser={Astro.locals.user}
                        initialIsSaved={savedItemIds.has(item.id)}
                    />
                ))
        }
    </div>
</div>
