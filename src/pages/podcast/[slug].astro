---
import SocialLayout from "../../layouts/SocialLayout.astro";
import LeftSidebar from "../../components/social/LeftSidebar.astro";
import EpisodeCard from "../../components/social/EpisodeCard"; // Reuse if possible or inline minimal list
import { supabase } from "../../lib/supabase";
import { ArrowLeft } from "lucide-react";

// 1. Get Slug from params
const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

// 2. Fetch Podcast Data
const { data: podcastData, error } = await supabase
    .from("podcasts")
    .select(
        `
        *,
        author:profiles(*)
    `,
    )
    .eq("slug", slug)
    .single();

const podcast = podcastData as any;

if (error || !podcast) {
    console.error("Podcast not found or error:", error);
    return Astro.redirect("/404");
}

// 3. Prepare Data
const coverImage =
    podcast.cover_image_url ||
    podcast.featured_image_url ||
    "/igm-default.webp";
const episodes = Array.isArray(podcast.episodes) ? podcast.episodes : [];

// Type definition
type Episode = {
    number: number;
    title: string;
    video_url: string;
    duration?: string;
};

const castEpisodes = episodes as Episode[];
castEpisodes.sort((a, b) => a.number - b.number);

// 4. Handle "Active Video" (Deep Link)
const videoParam = Astro.url.searchParams.get("v");

// Helper to extract ID (shared logic)
// Helper to extract ID (shared logic)
function extractVideoID(url: string) {
    if (!url) return "";
    const cleanUrl = url.trim();
    if (cleanUrl.length === 11 && !cleanUrl.includes("/")) return cleanUrl;
    const regExp =
        /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = cleanUrl.match(regExp);
    return match && match[2].length === 11 ? match[2] : "";
}

let activeVideoId = "";
let autoPlay = false;

if (videoParam) {
    activeVideoId = videoParam;
    autoPlay = true;
} else if (castEpisodes.length > 0) {
    // Optional: Default to first episode if user wants "Play" from Hero without clicking specific ep?
    // For now, if no param, show Cover.
}
---

<SocialLayout
    title={`${podcast.title} | Zvenia Podcasts`}
    description={podcast.description}
    hideRightSidebar={true}
>
    <!-- LEFT SIDEBAR -->
    <LeftSidebar slot="left-sidebar" />

    <!-- MAIN CONTENT -->
    <div
        class="grid grid-cols-1 lg:grid-cols-[1fr_340px] gap-6 pb-12 items-start"
    >
        <!-- CENTER COLUMN: PLAYER & INFO -->
        <div class="flex flex-col gap-6 w-full min-w-0">
            {/* Back Button (Aligned with Content) */}
            <div>
                <a
                    href="/mining/general-mining"
                    class="inline-flex items-center text-(--text-secondary) hover:text-(--text-main) transition-colors"
                    onclick="history.back(); return false;"
                >
                    <ArrowLeft className="w-4 h-4 mr-2" />
                    Back to podcasts
                </a>
            </div>

            <!-- ... (Player Block unchanged) ... -->
            <div class="w-full relative group flex justify-center z-10">
                <div
                    class="flex flex-col w-full relative bg-black border border-white/10 shadow-2xl"
                >
                    {/* Video Area */}
                    <div class="aspect-video w-full bg-black relative">
                        {
                            (() => {
                                const targetId =
                                    activeVideoId ||
                                    (castEpisodes.length > 0
                                        ? extractVideoID(
                                              castEpisodes[0].video_url,
                                          )
                                        : "");
                                return targetId ? (
                                    <iframe
                                        class="w-full h-full"
                                        src={`https://www.youtube.com/embed/${targetId}?autoplay=${activeVideoId ? 1 : 0}&rel=0&showinfo=0`}
                                        title="YouTube video player"
                                        frameborder="0"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                        allowfullscreen
                                    />
                                ) : (
                                    <div class="w-full h-full flex items-center justify-center text-white/20">
                                        No Episodes Available
                                    </div>
                                );
                            })()
                        }
                    </div>
                </div>
            </div>

            {/* PODCAST INFO */}
            {/* PODCAST INFO (Premium Card) */}
            <div
                class="flex flex-col sm:flex-row gap-6 bg-[#0b1c15] border-l-4 border-primary-500 p-6 shadow-2xl relative overflow-hidden group"
            >
                {/* Subtle Background Accent */}
                <div
                    class="absolute inset-0 bg-linear-to-r from-primary-900/10 to-transparent pointer-events-none"
                >
                </div>

                <div class="shrink-0 relative z-10">
                    <img
                        src={coverImage}
                        onerror="this.onerror=null; this.src='/igm-default.webp';"
                        alt={podcast.title}
                        class="w-32 aspect-3/4 object-cover border border-white/10 shadow-lg bg-black"
                    />
                </div>
                <div class="flex flex-col justify-center relative z-10 w-full">
                    <div class="flex items-center gap-3 mb-2">
                        <span
                            class="text-[10px] font-bold tracking-[0.2em] uppercase text-white/80"
                            >PODCAST SERIES</span
                        >
                        <div class="h-px w-12 bg-primary-500/30"></div>
                    </div>

                    <h1
                        class="text-2xl sm:text-3xl font-bold text-white mb-2 leading-tight"
                    >
                        {podcast.title}
                    </h1>

                    {
                        podcast.host && (
                            <div class="flex items-center gap-2 mb-4">
                                <span class="text-xs font-bold text-primary-200 uppercase tracking-wider">
                                    HOST:
                                </span>
                                <span class="text-sm font-bold text-white uppercase tracking-wide">
                                    {podcast.host}
                                </span>
                            </div>
                        )
                    }

                    <p
                        class="text-sm text-gray-300 leading-relaxed max-w-2xl line-clamp-3"
                    >
                        {
                            podcast.description ||
                                "Join us for an in-depth conversation on the future of mining."
                        }
                    </p>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: YOUTUBE STYLE SIDEBAR -->
        <div class="flex flex-col w-full h-full min-w-0">
            <div class="flex items-center justify-between mb-4 px-1">
                <h3
                    class="text-lg font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2"
                >
                    Episodes
                </h3>
            </div>

            <div
                class="flex flex-col gap-3 max-h-[calc(100vh-100px)] overflow-y-auto pr-2 hide-scrollbar"
            >
                {
                    castEpisodes.map((ep) => {
                        const vidId = extractVideoID(ep.video_url);
                        const currentId =
                            activeVideoId ||
                            (castEpisodes.length > 0
                                ? extractVideoID(castEpisodes[0].video_url)
                                : "");
                        const isActive = vidId === currentId;

                        return (
                            <a
                                href={`/podcast/${podcast.slug}?v=${vidId}`}
                                class={`group flex gap-3 p-2 transition-all duration-200 border-l-2 ${
                                    isActive
                                        ? "bg-primary-50 border-primary-500 border-t-0 border-r-0 border-b-0"
                                        : "border-transparent hover:border-gray-300 hover:bg-gray-50"
                                }`}
                            >
                                {/* Thumbnail (16:9 Sharp) */}
                                <div class="relative w-40 aspect-video shrink-0 bg-black overflow-hidden border border-gray-200 group-hover:border-gray-400">
                                    <img
                                        src={`https://img.youtube.com/vi/${vidId}/mqdefault.jpg`}
                                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                    />
                                    {isActive && (
                                        <div class="absolute inset-0 bg-black/60 flex items-center justify-center border border-primary-500">
                                            <div class="flex items-center gap-1">
                                                <div
                                                    class="w-1 h-4 bg-primary-500 animate-bounce"
                                                    style="animation-delay: 0s"
                                                />
                                                <div
                                                    class="w-1 h-4 bg-primary-500 animate-bounce"
                                                    style="animation-delay: 0.2s"
                                                />
                                                <div
                                                    class="w-1 h-4 bg-primary-500 animate-bounce"
                                                    style="animation-delay: 0.4s"
                                                />
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Clean Info (Sharp Typography) */}
                                <div class="flex flex-col min-w-0 py-1">
                                    <h4
                                        class={`text-sm font-bold leading-tight line-clamp-2 mb-1 ${isActive ? "text-primary-700" : "text-gray-900 group-hover:text-primary-700"}`}
                                    >
                                        {ep.title}
                                    </h4>
                                    <span
                                        class={`text-[10px] font-bold px-1.5 py-0.5 w-fit border tracking-wider ${isActive ? "text-primary-700 border-primary-200 bg-primary-100" : "text-gray-500 border-gray-200 bg-gray-50"}`}
                                    >
                                        EP #{ep.number}
                                    </span>
                                </div>
                            </a>
                        );
                    })
                }
            </div>
        </div>
    </div>
</SocialLayout>

<style>
    /* Hide scrollbar for Chrome, Safari and Opera */
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .hide-scrollbar {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
    }
</style>
