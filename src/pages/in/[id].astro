---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import PostCard from "../../components/social/PostCard.astro";
import EventCard from "../../components/social/EventCard.tsx";
import PodcastRow from "../../components/social/PodcastRow.tsx";
import ServiceCard from "../../components/social/ServiceCard.tsx";
import { supabase } from "../../lib/supabase";

// 1. Get ID from params
const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/404");
}

// 2. Fetch Profile Data
const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", id)
    .single();

if (profileError || !profile) {
    console.error("Profile not found:", profileError);
    return Astro.redirect("/404");
}

// 3. Role & Tab Logic (View Mode)
const role = profile.role || "Basic";
const activeTab = Astro.url.searchParams.get("tab") || "posts";

const rolePermissions = {
    Basic: ["posts"],
    Expert: ["posts", "podcasts"],
    Events: ["posts", "events"],
    Ads: ["posts", "services"],
    CountryManager: ["posts", "events", "podcasts", "services"],
    Administrator: ["posts", "events", "podcasts", "services"],
};

const allowedTabs = rolePermissions[role] || rolePermissions["Basic"];
const currentTab = allowedTabs.includes(activeTab) ? activeTab : allowedTabs[0];

// 4. Counts (Public content only)
// Note: We might need RLS policies to allow reading these counts for "public" profiles.
// Assuming public read access is enabled for content.
const tabCounts: Record<string, number> = {};
await Promise.all(
    allowedTabs.map(async (tab) => {
        const { count } = await supabase
            .from(tab)
            .select("*", { count: "exact", head: true })
            .eq("author_id", id);
        tabCounts[tab] = count || 0;
    }),
);

// 5. Content Fetching
let items: any[] = [];
try {
    if (currentTab === "posts") {
        const { data } = await supabase
            .from("posts")
            .select(`*, author:profiles(*), topics(*)`)
            .eq("author_id", id)
            .order("created_at", { ascending: false });
        items = data || [];
    } else if (currentTab === "events") {
        const { data } = await supabase
            .from("events")
            .select(`*, author:profiles(*)`)
            .eq("author_id", id)
            .order("start_date", { ascending: false });
        items = data || [];
    } else if (currentTab === "podcasts") {
        const { data } = await supabase
            .from("podcasts")
            .select(`*, author:profiles(*)`)
            .eq("author_id", id)
            .order("created_at", { ascending: false });
        items = data || [];
    } else if (currentTab === "services") {
        const { data } = await supabase
            .from("services")
            .select(`*, author:profiles(*)`)
            .eq("author_id", id)
            .order("created_at", { ascending: false });
        items = data || [];
    }
} catch (e: any) {
    console.error("Error fetching content:", e);
}

const userInitial = profile.email ? profile.email.charAt(0).toUpperCase() : "U";
const currentUser = Astro.locals.user; // For PostCard interactions
---

<Layout title={`${profile.full_name || profile.email} | ZVENIA`}>
    <Header slot="header" />
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            {/* LEFT COLUMN */}
            <div class="lg:col-span-3 space-y-6">
                {/* 1. Profile Card */}
                <div
                    class="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-xl overflow-hidden shadow-sm relative"
                >
                    {/* Banner */}
                    <div
                        class="h-48 bg-gradient-to-r from-gray-700 to-gray-600 relative"
                    >
                    </div>

                    {/* Header */}
                    <div class="px-6 pb-6 relative">
                        {/* Avatar */}
                        <div class="absolute -top-16 left-6">
                            <div
                                class="w-32 h-32 rounded-full border-4 border-[var(--bg-surface)] bg-[var(--bg-surface)] overflow-hidden flex items-center justify-center text-4xl text-primary-400 font-bold shadow-md relative"
                            >
                                {
                                    profile.avatar_url ? (
                                        <img
                                            src={profile.avatar_url}
                                            alt={profile.email}
                                            class="w-full h-full object-cover"
                                        />
                                    ) : (
                                        userInitial
                                    )
                                }
                            </div>
                        </div>

                        {/* Actions (Connect/Message - Placeholders for now) */}
                        <div class="flex justify-end pt-4 mb-2">
                            {/* Only show if not self? */}
                            <button
                                class="text-[var(--text-secondary)] hover:bg-[var(--bg-surface-hover)] p-2 rounded-full"
                            >
                                <svg
                                    class="w-6 h-6"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                    ><path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                                    ></path></svg
                                >
                            </button>
                        </div>

                        {/* Info */}
                        <div class="mt-4">
                            <h1
                                class="text-2xl font-bold text-[var(--text-main)] flex items-center gap-2"
                            >
                                {
                                    profile.full_name ||
                                        profile.username ||
                                        profile.email
                                }
                                {
                                    role !== "Basic" && (
                                        <span
                                            class="text-blue-500"
                                            title="Verified"
                                        >
                                            <svg
                                                class="w-5 h-5 fill-current"
                                                viewBox="0 0 20 20"
                                            >
                                                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" />
                                            </svg>
                                        </span>
                                    )
                                }
                            </h1>
                            <p
                                class="text-[var(--text-main)] text-lg font-medium mt-1"
                            >
                                {profile.profession || `${role} Account`}
                            </p>
                            <p
                                class="text-[var(--text-secondary)] text-sm mt-1 flex items-center gap-1"
                            >
                                <svg
                                    class="w-4 h-4 text-[var(--text-secondary)]"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    ><path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                    ></path><path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                    ></path></svg
                                >
                                {profile.country || "Location not set"}
                            </p>
                        </div>
                    </div>
                </div>

                {/* 2. Content */}
                <div
                    class="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-xl shadow-sm overflow-hidden"
                >
                    <div class="border-b border-[var(--border-color)] px-4">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            {
                                allowedTabs.map((tab) => (
                                    <a
                                        href={`?tab=${tab}`}
                                        class={`
                                        whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm capitalize transition-colors
                                        ${
                                            currentTab === tab
                                                ? "border-emerald-600 text-emerald-600"
                                                : "border-transparent text-[var(--text-secondary)] hover:text-[var(--text-main)] hover:border-[var(--border-color)]"
                                        }
                                    `}
                                    >
                                        {tab}{" "}
                                        <span class="opacity-60 ml-1">
                                            ({tabCounts[tab] || 0})
                                        </span>
                                    </a>
                                ))
                            }
                        </nav>
                    </div>

                    <div class="p-6">
                        {
                            items.length === 0 ? (
                                <div class="text-center py-10">
                                    <div class="text-4xl mb-4 opacity-50 grayscale">
                                        ðŸ“­
                                    </div>
                                    <h3 class="text-lg font-bold text-[var(--text-main)] mb-1">
                                        Hasn't posted yet
                                    </h3>
                                </div>
                            ) : (
                                <div class="space-y-6">
                                    {currentTab === "posts" &&
                                        items.map((post) => (
                                            <PostCard
                                                post={post}
                                                currentUser={currentUser}
                                            />
                                        ))}
                                    {currentTab === "events" &&
                                        items.map((event) => (
                                            <EventCard
                                                event={event}
                                                currentUser={currentUser}
                                                client:visible
                                            />
                                        ))}
                                    {currentTab === "podcasts" &&
                                        items.map((podcast) => (
                                            <PodcastRow
                                                podcast={podcast}
                                                currentUser={currentUser}
                                                client:visible
                                            />
                                        ))}
                                    {currentTab === "services" &&
                                        items.map((service) => (
                                            <ServiceCard
                                                service={service}
                                                currentUser={currentUser}
                                                client:visible
                                            />
                                        ))}
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>

            {/* RIGHT COLUMN */}
            <div class="hidden lg:block space-y-4">
                {/* Ad / Promo */}
                <div
                    class="bg-[var(--bg-card)] border border-[var(--border-color)] rounded-xl p-4 shadow-sm text-center"
                >
                    <p class="text-[var(--text-secondary)] text-xs mb-2">
                        Ad â€¢
                    </p>
                    <div
                        class="bg-[var(--bg-surface-hover)] h-32 rounded-lg flex items-center justify-center mb-2"
                    >
                        <span class="text-[var(--text-secondary)] font-bold"
                            >ZVENIA Hire</span
                        >
                    </div>
                    <p class="text-[var(--text-main)] text-sm font-medium">
                        See who's hiring.
                    </p>
                </div>
            </div>
        </div>
    </div>
</Layout>
