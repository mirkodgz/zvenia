---
import SocialLayout from "../../layouts/SocialLayout.astro";
import PostAuthorSidebarCard from "../../components/social/PostAuthorSidebarCard.astro";
import AdsSidebar from "../../components/social/AdsSidebar.astro";
import LeftSidebar from "../../components/social/LeftSidebar.astro";
import PostCard from "../../components/social/PostCard.astro";
import { supabase } from "../../lib/supabase";
import type { Database } from "../../types/database.types";

const { slug } = Astro.params;

if (!slug) return Astro.redirect("/404");

// Hybrid lookup: slug or UUID
const isUuid =
    /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(
        slug,
    );
const columnName = isUuid ? "id" : "slug";

console.log(
    `[POST DEBUG] slug: "${slug}", isUuid: ${isUuid}, col: ${columnName}`,
);

// Fetch Post with full details
type PostWithRelations = Database["public"]["Tables"]["posts"]["Row"] & {
    author: {
        full_name: string | null;
        avatar_url: string | null;
        profession: string | null;
        company: string | null;
        profile_slug: string | null;
    } | null;
    topic: {
        name: string;
        slug: string;
    } | null;
};

const { data: rawPost, error } = await supabase
    .from("posts")
    .select(
        `
        *, 
        author:profiles(full_name, avatar_url, profession, company, profile_slug),
        topic:topics(name, slug)
    `,
    )
    .eq(columnName, slug)
    .single();

if (error) {
    console.error(`[POST DEBUG] Error fetching post:`, error);
}

if (error || !rawPost) {
    console.error("Post not found:", error);
    return Astro.redirect("/404");
}

const post = rawPost as PostWithRelations;

const currentUser = Astro.locals.user;

// --- Smart Link Preview Logic ---
let ogImageUrl = "/share-default.png"; // Fallback default
let ogType: "article" | "video.other" = "article";

/* 
  Priority Logic:
  1. YouTube Thumbnail (Highest Quality)
  2. Featured Image (if exists)
  3. Default Fallback
*/

// Cast metadata to any to access dynamic fields
const metadata = post.metadata as any;

if (metadata?.youtube_url) {
    ogType = "video.other";
    try {
        const url = metadata.youtube_url;
        let videoId = "";
        if (url.includes("youtube.com/watch")) {
            videoId = new URL(url).searchParams.get("v") || "";
        } else if (url.includes("youtu.be/")) {
            videoId = url.split("youtu.be/")[1].split("?")[0];
        }
        if (videoId) {
            ogImageUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        }
    } catch (e) {
        console.error("Error extracting YouTube ID", e);
    }
} else if (post.featured_image_url) {
    // If user uploaded a dedicated cover (for Image, Video, or PDF posts)
    ogImageUrl = post.featured_image_url;
} else if (metadata?.video_url) {
    ogType = "video.other";
    // Native Video without cover -> Fallback
    ogImageUrl = "/share-default.png";
}

// Ensure clean text description for OG
// Cast post to any to access potentially missing description field if not in generated types, or just use content
const p = post as any;
const cleanDescription = (p.description || p.content || "")
    .replace(/<[^>]*>?/gm, "")
    .slice(0, 160)
    .trim();
---

<SocialLayout
    title={`${post.title} | Zvenia Social`}
    description={cleanDescription}
    image={ogImageUrl}
    type={ogType}
    hideRightSidebar={true}
>
    <!-- LEFT SIDEBAR: 25 Mining Topics (always visible, global component) -->
    <LeftSidebar slot="left-sidebar" activeTopicSlug={post.topic?.slug} />

    <!-- MAIN CONTENT: 3-column layout inside the content area -->
    <div class="w-full px-4 sm:px-6">
        <div
            class="flex flex-col lg:flex-row gap-6 items-start lg:justify-between"
        >
            <!-- Column 1: Author Card (Left) - Shown first on mobile, left on desktop -->
            <aside
                class="shrink-0 w-full lg:w-auto order-1"
                style="flex-basis: 220px;"
            >
                <PostAuthorSidebarCard
                    authorName={post.author?.full_name || "Unknown Author"}
                    authorAvatarUrl={post.author?.avatar_url}
                    profileUrl={post.author?.profile_slug
                        ? `/profile/${post.author.profile_slug}`
                        : `/in/${post.author_id}`}
                />
            </aside>

            <!-- Column 2: Post Content (Center) - Second on mobile, center on desktop -->
            <main
                class="shrink-0 mx-auto lg:mx-0 order-2"
                style="width: 500px; max-width: 100%;"
            >
                <PostCard
                    post={post}
                    currentUser={currentUser}
                    isDetail={true}
                />
            </main>

            <!-- Column 3: ADS (Right) - Hidden on mobile, shown on desktop -->
            <aside
                class="hidden lg:block shrink-0 order-3"
                style="flex-basis: 200px;"
            >
                <AdsSidebar />
            </aside>
        </div>
    </div>
</SocialLayout>
