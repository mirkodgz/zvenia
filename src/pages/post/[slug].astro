---
import SocialLayout from '../../layouts/SocialLayout.astro';
import LeftSidebar from '../../components/social/LeftSidebar.astro';
import RightSidebar from '../../components/social/RightSidebar.astro';
import PostCard from '../../components/social/PostCard.astro';
import { supabase } from '../../lib/supabase';

const { slug } = Astro.params;

if (!slug) return Astro.redirect('/404');

// Hybrid lookup: slug or UUID
const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(slug);
const columnName = isUuid ? 'id' : 'slug';

console.log(`[POST DEBUG] slug: "${slug}", isUuid: ${isUuid}, col: ${columnName}`);

// Fetch Post with full details
const { data: post, error } = await supabase
    .from('posts')
    .select(`
        *, 
        author:profiles(full_name, avatar_url, profession, company),
        topic:topics(name, slug)
    `)
    .eq(columnName, slug)
    .single();

if (error) {
    console.error(`[POST DEBUG] Error fetching post:`, error);
}

if (error || !post) {
    console.error("Post not found:", error);
    return Astro.redirect('/404');
}

const currentUser = Astro.locals.user;
---

<SocialLayout title={`${post.title} | Zvenia Social`}>
    
    <LeftSidebar slot="left-sidebar" />
    
    <div class="max-w-3xl mx-auto px-4 sm:px-0">
        <PostCard post={post} currentUser={currentUser} isDetail={true} />
    </div>

    <RightSidebar slot="right-sidebar" />

</SocialLayout>
