
---
import Layout from '../../../layouts/Layout.astro';
import PostForm from '../../../components/dashboard/forms/PostForm';

const { id } = Astro.params;

if (!id) {
    return Astro.redirect('/404');
}

// 1. Check Auth in SSR (Use Middleware locals)
const user = Astro.locals.user;
if (!user) {
    return Astro.redirect('/login');
}

// 2. Fetch Post with Topic (Use Middleware authenticated client)
// 2. Fetch Post (Simplified, no bridge table)
const { data: post, error } = await Astro.locals.supabase
    .from('posts')
    .select('*')
    .eq('id', id)
    .single();

if (error || !post) {
   return Astro.redirect('/404');
}

// 3. Ownership Check
if (post.author_id !== user.id) {
    return Astro.redirect('/');
}

// 4. Transform Data for Form
let topicSlug = '';

// Try to resolve topic slug if topic_id exists
if (post.topic_id) {
    const { data: topicData } = await Astro.locals.supabase
        .from('topics')
        .select('slug')
        .eq('id', post.topic_id)
        .single();
    
    if (topicData) {
        topicSlug = topicData.slug;
    }
}

const initialData = {
    ...post,
    topic_id: topicSlug // properties must match PostFormData interface in PostForm
};
---

<Layout title={`Edit Post: ${post.title}`}>
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-[var(--text-main)] mb-8 text-center">Edit Post</h1>
        
        <PostForm 
            client:load 
            currentUser={user} 
            initialData={initialData}
        />
    </div>
</Layout>
