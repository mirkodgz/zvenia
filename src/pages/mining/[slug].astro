---
import SocialLayout from "../../layouts/SocialLayout.astro";
import LeftSidebar from "../../components/social/LeftSidebar.astro";
import RightSidebar from "../../components/social/RightSidebar.astro";
import EventCard from "../../components/social/EventCard";
import PostCard from "../../components/social/PostCard.astro";
import PodcastRow from "../../components/social/PodcastRow";
import ServiceCard from "../../components/social/ServiceCard";
import ServiceRow from "../../components/social/ServiceRow";
import { supabase } from "../../lib/supabase";

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

// SSR: Fetch Topic by Slug
let topic: any;

if (slug === "all" || slug === "all-topics") {
    topic = {
        id: null,
        name: "All Topics",
        slug: "all",
        description: "browse all posts from every category.",
    };
} else {
    const { data } = await supabase
        .from("topics")
        .select("*")
        .eq("slug", slug)
        .single();
    topic = data;
}

if (!topic) {
    return Astro.redirect("/404");
}

// Helper to fetch IDs from junction tables
async function getLinkedIds(table: string, topicId: string, idCol: string) {
    const { data } = await supabase
        .from(table)
        .select(idCol)
        .eq("topic_id", topicId);
    return data?.map((r: any) => r[idCol]) || [];
}

// 2. Parallel Fetching of Content Relations
console.log(
    `[TOPIC DEBUG] Fetching content for topic: ${topic.name} (${topic.id})`,
);

const [postIds, podcastIds, talkIds, presentationIds, serviceIds, eventIds] =
    await Promise.all([
        // Posts: Direct FK or All
        (topic.id
            ? supabase
                  .from("posts")
                  .select("id")
                  .eq("topic_id", topic.id)
                  .order("created_at", { ascending: false })
                  .order("id", { ascending: true })
            : supabase
                  .from("posts")
                  .select("id")
                  .order("created_at", { ascending: false })
                  .order("id", { ascending: true })
                  .limit(2000)
        ).then(({ data, error }) => {
            if (error) console.error("[TOPIC DEBUG] Post Fetch Error:", error);
            return data?.map((p: any) => p.id) || [];
        }),

        // Podcasts: Direct FK
        (topic.id
            ? supabase
                  .from("podcasts")
                  .select("id")
                  .eq("topic_id", topic.id)
                  .order("created_at", { ascending: false })
            : supabase.from("podcasts").select("id").limit(20)
        ).then(({ data }) => data?.map((p: any) => p.id) || []),

        // Talks: Direct FK (Simplified)
        (topic.id
            ? supabase
                  .from("talks")
                  .select("id")
                  .eq("topic_id", topic.id)
                  .order("created_at", { ascending: false })
            : supabase.from("talks").select("id").limit(20)
        ).then(({ data }) => data?.map((t: any) => t.id) || []),
        topic.id
            ? getLinkedIds("presentations_topics", topic.id, "presentations_id")
            : Promise.resolve([]),

        // Services: Direct FK
        (topic.id
            ? supabase
                  .from("services")
                  .select("id")
                  .eq("topic_id", topic.id)
                  .order("created_at", { ascending: false })
            : supabase.from("services").select("id").limit(20)
        ).then(({ data }) => data?.map((s: any) => s.id) || []),

        // Events: Direct FK
        (topic.id
            ? supabase
                  .from("events")
                  .select("id")
                  .eq("topic_id", topic.id)
                  .order("created_at", { ascending: false })
            : supabase.from("events").select("id").limit(100)
        ).then(({ data }) => data?.map((e: any) => e.id) || []),
    ]);

console.log(
    `[TOPIC DEBUG] Found IDs - Posts: ${postIds.length}, Events: ${eventIds.length}, Podcasts: ${podcastIds.length}, Services: ${serviceIds.length}`,
);

// 3. Fetch Actual Content
const fetchContent = async (
    table: string,
    ids: string[],
    typeLabel: string,
) => {
    if (ids.length === 0) return [];

    // Safety: Slice IDs to max 500 to prevent "URI too long" errors with Supabase GET
    // Since we pre-sort the IDs (see below), taking the first N is safe.
    // Increased from 100 to 500 to support topics with many posts
    const safeIds = ids.slice(0, 500);

    let selectQuery = "*";
    if (table === "posts") {
        selectQuery =
            "*, author:profiles(full_name, avatar_url, profession, company, profile_slug)";
    } else if (table === "services") {
        selectQuery = "*, type:service_types(name, slug)";
    }

    let query = supabase.from(table).select(selectQuery).in("id", safeIds);

    // For Events, only show FUTURE events (date >= now)
    if (table === "events") {
        const now = new Date().toISOString();
        query = query
            .or(`end_date.gte.${now},start_date.gte.${now}`)
            .order("start_date", { ascending: true });
    } else if (table === "services") {
        query = query.order("created_at", { ascending: false });
    } else {
        // Maintain order for posts/others
        query = query
            .order("created_at", { ascending: false })
            .order("id", { ascending: true });
    }

    // Initial limit: 15 posts for infinite scroll, 100 for events, 20 for others
    const limit = table === "posts" ? 15 : table === "events" ? 100 : 20;
    const { data } = await query.limit(limit);
    return (
        data?.map((item: any) => ({
            ...item,
            type: typeLabel,
            collection: table,
        })) || []
    );
};

const [
    postItems,
    podcastItems,
    talkItems,
    presentationItems,
    serviceItems,
    realEventItems,
] = await Promise.all([
    fetchContent("posts", postIds, "Post"),
    fetchContent("podcasts", podcastIds, "Podcast"),
    fetchContent("talks", talkIds, "Talk"),
    fetchContent("presentations", presentationIds, "Presentation"),
    fetchContent("services", serviceIds, "Service"),
    fetchContent("events", eventIds, "Event"),
]);

// Events Section is now just Real Events
const eventItems = realEventItems;

// Simple Date Formatter
const formatDate = (dateStr: string | null) => {
    if (!dateStr) return "";
    const date = new Date(dateStr);
    return date.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
    });
};
---

<SocialLayout title={`${topic.name} - Mining Topic | ZVENIA`}>
    <LeftSidebar slot="left-sidebar" activeTopicSlug={topic.slug} />
    <RightSidebar slot="right-sidebar" />

    <!-- MAIN CONTENT: Clean standard layout -->
    <!-- MAIN CONTENT: Clean standard layout -->
    <div class="w-full mx-auto space-y-6">
        <!-- Topic Content (Center) -->
        <main class="w-full">
            <!-- FIXED TABS CONTAINER (Hard Fix) -->
            <!-- Matches SocialLayout padding: lg:pl-[270px] lg:pr-[300px] to align with center/main content area -->
            <div
                class="fixed top-[70px] left-0 right-0 z-999 pointer-events-none lg:pl-[270px] lg:pr-[300px]"
            >
                <!-- Interactive Bar -->
                <div
                    class="pointer-events-auto bg-[#f3f3f3] pt-2 pb-2 mx-auto max-w-4xl px-4"
                >
                    <div class="max-w-[600px] mx-auto w-full">
                        <div
                            class="grid grid-cols-2 sm:grid-cols-4 gap-2 w-full"
                        >
                            <button
                                class="tab-btn btn-tab btn-tab-active shrink-0 w-full justify-center flex items-center gap-2"
                                data-target="posts"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-4 h-4"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
                                    ></path><polyline points="14 2 14 8 20 8"
                                    ></polyline><line
                                        x1="16"
                                        y1="13"
                                        x2="8"
                                        y2="13"></line><line
                                        x1="16"
                                        y1="17"
                                        x2="8"
                                        y2="17"></line><line
                                        x1="10"
                                        y1="9"
                                        x2="8"
                                        y2="9"></line></svg
                                >
                                <span
                                    class="uppercase font-bold text-xs whitespace-nowrap pt-0.5"
                                    >POSTS ({postIds.length})</span
                                >
                            </button>
                            <button
                                class="tab-btn btn-tab shrink-0 w-full justify-center flex items-center gap-2"
                                data-target="events"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-4 h-4"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        x="3"
                                        y="4"
                                        width="18"
                                        height="18"
                                        rx="2"
                                        ry="2"></rect><line
                                        x1="16"
                                        y1="2"
                                        x2="16"
                                        y2="6"></line><line
                                        x1="8"
                                        y1="2"
                                        x2="8"
                                        y2="6"></line><line
                                        x1="3"
                                        y1="10"
                                        x2="21"
                                        y2="10"></line></svg
                                >
                                <span
                                    class="uppercase font-bold text-xs whitespace-nowrap pt-0.5"
                                    >EVENTS ({eventIds.length})</span
                                >
                            </button>
                            <button
                                class="tab-btn btn-tab shrink-0 w-full justify-center flex items-center gap-2"
                                data-target="podcasts"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-4 h-4"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                                    ></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"
                                    ></path><line
                                        x1="12"
                                        y1="19"
                                        x2="12"
                                        y2="23"></line><line
                                        x1="8"
                                        y1="23"
                                        x2="16"
                                        y2="23"></line></svg
                                >
                                <span
                                    class="uppercase font-bold text-xs whitespace-nowrap pt-0.5"
                                    >PODCASTS ({podcastIds.length})</span
                                >
                            </button>
                            <button
                                class="tab-btn btn-tab shrink-0 w-full justify-center flex items-center gap-2"
                                data-target="services"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-4 h-4"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        x="2"
                                        y="7"
                                        width="20"
                                        height="14"
                                        rx="2"
                                        ry="2"></rect><path
                                        d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"
                                    ></path></svg
                                >
                                <span
                                    class="uppercase font-bold text-xs whitespace-nowrap pt-0.5"
                                    >SERVICES ({serviceIds.length})</span
                                >
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SPACER to prevents content overlap -->
            <div class="h-16 mb-4"></div>

            <!-- First Block: Header + Search -->
            <div class="mb-2">
                <!-- Topic Header -->
                <div class="mb-2 max-w-[600px] mx-auto">
                    <h1 class="text-3xl font-bold text-dark mb-1">
                        {topic.name}
                    </h1>
                    <p
                        class="text-dark text-sm"
                        style="font-size: 15px; font-weight: 400;"
                    >
                        Latest discussions, news, and insights on {topic.name}.
                    </p>
                </div>

                <!-- Search Bar (Subtle & Below Tabs) -->
                <div class="mb-2 relative group w-full max-w-[600px] mx-auto">
                    <div
                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                    >
                        <svg
                            class="h-4 w-4 text-gray-400 group-focus-within:text-primary-400 transition-colors"
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            ></path>
                        </svg>
                    </div>
                    <input
                        type="text"
                        id="post-search"
                        placeholder="Search in this topic..."
                        class="block w-full pl-9 pr-4 py-2 bg-transparent border border-gray-200 rounded-none text-dark placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-primary-500 transition-all text-xs"
                    />
                    <div
                        class="absolute inset-y-0 right-0 pr-3 flex items-center"
                    >
                        <div
                            id="search-spinner"
                            class="hidden animate-spin h-3 w-3 text-primary-400"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                ></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Block: Content Sections -->
            <div class="space-y-4">
                <!-- Content Sections -->

                <!-- POSTS SECTION -->
                <div
                    id="tab-posts"
                    class="tab-content space-y-8 max-w-[600px] mx-auto"
                >
                    {
                        postItems.length === 0 ? (
                            <div
                                class="text-center py-12 bg-white rounded-lg border border-(--border-color) flex flex-col items-center"
                                style="border-radius: 0.6666666667rem;"
                            >
                                <div class="mb-4 text-gray-400">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-12 h-12"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="1.5"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <>
                                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                            <polyline points="14 2 14 8 20 8" />
                                            <line
                                                x1="16"
                                                y1="13"
                                                x2="8"
                                                y2="13"
                                            />
                                            <line
                                                x1="16"
                                                y1="17"
                                                x2="8"
                                                y2="17"
                                            />
                                            <line
                                                x1="10"
                                                y1="9"
                                                x2="8"
                                                y2="9"
                                            />
                                        </>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-dark mb-2">
                                    No posts yet
                                </h3>
                                <p
                                    class="text-dark text-sm"
                                    style="font-size: 15px;"
                                >
                                    Be the first to post about {topic.name}!
                                </p>
                            </div>
                        ) : (
                            postItems.map((item) => (
                                <PostCard
                                    post={item}
                                    currentUser={Astro.locals.user}
                                />
                            ))
                        )
                    }

                    <!-- Infinite Scroll Sentinel -->
                    <div
                        id="scroll-sentinel"
                        class="h-20 flex items-center justify-center"
                    >
                        <div
                            id="loading-indicator"
                            class="hidden text-xs text-dark animate-pulse"
                        >
                            Loading more posts...
                        </div>
                    </div>

                    <!-- Load More Button -->
                    <div
                        class="mt-8 text-center pb-12 hidden"
                        id="load-more-container"
                    >
                        <button
                            id="load-more-btn"
                            class="px-8 py-3 bg-white border border-(--border-color) rounded-full text-sm font-bold text-dark hover:border-primary-500 hover:bg-primary-500/10 transition-all disabled:opacity-50 disabled:cursor-not-allowed uppercase tracking-wider"
                            style="border-radius: 0.6666666667rem;"
                        >
                            Load More Posts
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <script
            define:vars={{ initialOffset: postItems.length, currentSlug: slug }}
        >
            let offset = initialOffset;
            let currentSearch = "";
            const limit = 15; // Load 15 posts at a time for smooth infinite scroll
            let isLoading = false;
            let hasMorePosts = true;

            const btn = document.getElementById("load-more-btn");
            const loadMoreContainer = document.getElementById(
                "load-more-container",
            );
            const sentinel = document.getElementById("scroll-sentinel");
            const loadingIndicator =
                document.getElementById("loading-indicator");
            const container = document.getElementById("tab-posts");
            const searchInput = document.getElementById("post-search");
            const searchSpinner = document.getElementById("search-spinner");

            // Debounce Helper
            const debounce = (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            };

            const loadPosts = async (isSearch = false) => {
                // Prevent multiple simultaneous loads
                if (isLoading) return;
                if (!hasMorePosts && !isSearch) return;

                isLoading = true;
                if (isSearch && searchSpinner)
                    searchSpinner.classList.remove("hidden");
                if (!isSearch && loadingIndicator)
                    loadingIndicator.classList.remove("hidden");
                if (btn) btn.disabled = true;

                try {
                    const fetchOffset = isSearch ? 0 : offset;
                    const url = `/partials/posts-partial?slug=${currentSlug}&limit=${limit}&offset=${fetchOffset}&search=${encodeURIComponent(currentSearch)}`;

                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Fetch failed");

                    const html = await res.text();

                    if (isSearch) {
                        // Replace Content
                        container.innerHTML = html;
                        offset = limit; // Next offset
                        hasMorePosts = html.trim().length > 0;
                        if (loadMoreContainer)
                            loadMoreContainer.classList.add("hidden");
                    } else {
                        // Append Content (Infinite Scroll)
                        if (!html.trim()) {
                            hasMorePosts = false;
                            if (sentinel) sentinel.classList.add("hidden");
                            if (loadMoreContainer)
                                loadMoreContainer.classList.add("hidden");
                            return;
                        }
                        const temp = document.createElement("div");
                        temp.innerHTML = html;
                        while (temp.firstChild) {
                            container.appendChild(temp.firstChild);
                        }
                        offset += limit;
                        hasMorePosts = true;
                    }

                    // Re-bind listeners
                    if (typeof window.attachListeners === "function") {
                        window.attachListeners();
                    }
                } catch (e) {
                    console.error(e);
                    hasMorePosts = false;
                    if (sentinel) sentinel.classList.add("hidden");
                    // Show manual load button as fallback
                    if (loadMoreContainer)
                        loadMoreContainer.classList.remove("hidden");
                    if (btn)
                        btn.textContent =
                            "Error loading posts. Click to retry.";
                } finally {
                    isLoading = false;
                    if (searchSpinner) searchSpinner.classList.add("hidden");
                    if (loadingIndicator)
                        loadingIndicator.classList.add("hidden");
                    if (btn) btn.disabled = false;
                }
            };

            // Intersection Observer for Infinite Scroll
            if (sentinel && "IntersectionObserver" in window) {
                const observer = new IntersectionObserver(
                    (entries) => {
                        entries.forEach((entry) => {
                            if (
                                entry.isIntersecting &&
                                hasMorePosts &&
                                !isLoading &&
                                !currentSearch
                            ) {
                                loadPosts(false);
                            }
                        });
                    },
                    {
                        rootMargin: "200px", // Start loading 200px before reaching the sentinel
                    },
                );

                observer.observe(sentinel);
            } else {
                // Fallback: Show manual load button if IntersectionObserver is not supported
                if (loadMoreContainer)
                    loadMoreContainer.classList.remove("hidden");
            }

            // Search Listener
            if (searchInput) {
                searchInput.addEventListener(
                    "input",
                    debounce((e) => {
                        currentSearch = e.target.value.trim();
                        hasMorePosts = true; // Reset for new search
                        loadPosts(true);
                    }, 500),
                );
            }

            // Manual Load More Button (fallback)
            if (btn) {
                btn.addEventListener("click", () => loadPosts(false));
            }

            // Hide sentinel if initial load shows all posts
            if (initialOffset < limit) {
                if (sentinel) sentinel.classList.add("hidden");
            }
        </script>

        <!-- EVENTS SECTION -->
        <div
            id="tab-events"
            class="tab-content hidden space-y-4 max-w-4xl mx-auto"
        >
            <!-- Event Header (Matching Home) -->
            <div class="flex justify-between items-center px-0 mb-4">
                <h3
                    class="text-lg font-bold flex items-center gap-2 text-(--text-main)"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5 text-primary-400"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"
                        ></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Upcoming Events
                </h3>
                <span class="text-xs text-gray-500"
                    >Sorted by: <span class="font-bold text-(--text-main)"
                        >Newest</span
                    ></span
                >
            </div>

            {
                eventItems.length === 0 ? (
                    <div
                        class="text-center py-12 bg-white rounded-lg border border-(--border-color) flex flex-col items-center"
                        style="border-radius: 0.6666666667rem;"
                    >
                        <div class="mb-4 text-gray-400">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-12 h-12"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <rect
                                    x="3"
                                    y="4"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"
                                />
                                <line x1="16" y1="2" x2="16" y2="6" />
                                <line x1="8" y1="2" x2="8" y2="6" />
                                <line x1="3" y1="10" x2="21" y2="10" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-dark mb-2">
                            No events scheduled
                        </h3>
                    </div>
                ) : (
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {eventItems.map((item) => (
                            <EventCard
                                client:load
                                event={item}
                                currentUser={Astro.locals.user}
                            />
                        ))}
                    </div>
                )
            }
        </div>

        <!-- PODCASTS SECTION -->
        <div id="tab-podcasts" class="tab-content hidden space-y-4">
            {
                podcastItems.length === 0 ? (
                    <div
                        class="text-center py-12 bg-white rounded-lg border border-(--border-color) flex flex-col items-center"
                        style="border-radius: 0.6666666667rem;"
                    >
                        <div class="mb-4 text-gray-400">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-12 h-12"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <>
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                    <line x1="12" y1="19" x2="12" y2="23" />
                                    <line x1="8" y1="23" x2="16" y2="23" />
                                </>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-dark mb-2">
                            No podcasts yet
                        </h3>
                    </div>
                ) : (
                    podcastItems.map((item) => (
                        <PodcastRow
                            client:load
                            podcast={item}
                            currentUser={Astro.locals.user}
                        />
                    ))
                )
            }
        </div>

        <!-- SERVICES SECTION -->
        <div
            id="tab-services"
            class="tab-content hidden space-y-4 max-w-4xl mx-auto"
        >
            {
                serviceItems.length === 0 ? (
                    <div
                        class="text-center py-12 bg-white rounded-lg border border-(--border-color) flex flex-col items-center"
                        style="border-radius: 0.6666666667rem;"
                    >
                        <div class="mb-4 text-gray-400">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-12 h-12"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <>
                                    <rect
                                        x="2"
                                        y="7"
                                        width="20"
                                        height="14"
                                        rx="2"
                                        ry="2"
                                    />
                                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                                </>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-dark mb-2">
                            No services found
                        </h3>
                    </div>
                ) : (
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {serviceItems.map((item) => (
                            <ServiceCard
                                client:load
                                service={item}
                                currentUser={Astro.locals.user}
                            />
                        ))}
                    </div>
                )
            }
        </div>
        {/* --- VIDEO MODAL REMOVED (Pivot to Single Page) --- */}

        {/* Close Button (Brand Colors: Dark Green + Neon Green Accent) */}

        {/* Video Container (Aspect Ratio Maintained) */}

        {/* Control Bar (Below Video) */}
    </div>

    <script>
        // Tab Switching Logic
        const initTabs = () => {
            const buttons = document.querySelectorAll(".tab-btn");
            const contents = document.querySelectorAll(".tab-content");

            // Restore active tab from generic localStorage if available
            const savedTab = localStorage.getItem("zvenia-active-tab-legacy");
            if (savedTab) {
                // Validate it exists
                const targetContent = document.getElementById(
                    `tab-${savedTab}`,
                );
                if (targetContent) {
                    // Update buttons
                    buttons.forEach((b) => {
                        b.classList.remove("btn-tab-active");
                        if (b.getAttribute("data-target") === savedTab) {
                            b.classList.add("btn-tab-active");
                        }
                    });
                    // Update Content
                    contents.forEach((c) => c.classList.add("hidden"));
                    targetContent.classList.remove("hidden");
                }
            }

            buttons.forEach((btn) => {
                // Clone to remove old listeners (safe practice)
                const newBtn = btn.cloneNode(true) as Element;
                if (btn.parentNode) {
                    btn.parentNode.replaceChild(newBtn, btn);
                }

                newBtn.addEventListener("click", () => {
                    const targetId = newBtn.getAttribute("data-target");

                    // Toggle Buttons
                    const allButtons = document.querySelectorAll(".tab-btn");
                    allButtons.forEach((b) =>
                        b.classList.remove("btn-tab-active"),
                    );
                    newBtn.classList.add("btn-tab-active");

                    // Toggle Content
                    contents.forEach((c) => c.classList.add("hidden"));
                    document
                        .getElementById(`tab-${targetId}`)
                        ?.classList.remove("hidden");

                    // Save Preference
                    if (targetId)
                        localStorage.setItem(
                            "zvenia-active-tab-legacy",
                            targetId,
                        );
                });
            });
        };

        // Run on load and after Astro transitions (if enabled)
        initTabs();
        document.addEventListener("astro:page-load", initTabs);

        // --- VIDEO PLAYER LOGIC REMOVED (Pivot to Single Page) ---
    </script>
</SocialLayout>
