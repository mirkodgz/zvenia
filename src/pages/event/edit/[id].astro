---
import Layout from '../../../layouts/Layout.astro';
import EventForm from '../../../components/dashboard/forms/EventForm';

const { id } = Astro.params;

if (!id) {
    return Astro.redirect('/404');
}

// 1. Check Auth
const user = Astro.locals.user;
if (!user) {
    return Astro.redirect('/login');
}

// 2. Fetch Event with Related Data
const { data: event, error } = await Astro.locals.supabase
    .from('events')
    .select(`
        *,
        topic:topics (
            slug,
            name
        )
    `)
    .eq('id', id)
    .single();

if (error || !event) {
    console.error("Error fetching event for edit:", error);
    return Astro.redirect('/404');
}

// 3. Ownership Check
if (event.author_id !== user.id) {
    return Astro.redirect('/');
}

// 4. Transform Data for Form
const topicSlug = event.topic?.slug || '';

const initialData = {
    ...event,
    topic_slug: topicSlug
};
---

<Layout title={`Edit Event: ${event.title}`}>
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-white mb-8 text-center">Edit Event</h1>
        
        <EventForm 
            client:load 
            currentUser={user} 
            initialData={initialData}
        />
    </div>
</Layout>
