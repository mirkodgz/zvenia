---
import Layout from '../../layouts/Layout.astro';
import { createSupabaseServerClient } from '../../lib/supabase';

const { slug } = Astro.params;

const supabase = createSupabaseServerClient({ req: Astro.request, cookies: Astro.cookies });

// Fetch Event Data with Relations
const { data: event, error } = await supabase
    .from('events')
    .select(`
        *,
        type:event_types(name, slug),
        language:event_languages(name, code),
        format:event_formats(name, slug),
        price:event_prices(name, slug)
    `)
    .eq('slug', slug)
    .single();

if (error || !event) {
    return Astro.redirect('/404');
}

// Format Dates
const formatDate = (dateStr) => {
    if (!dateStr) return '';
    return new Date(dateStr).toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
    });
};
---

<Layout title={event.title}>
    <main class="min-h-screen bg-black pb-20">
        
        {/* HERO / COVER SECTION */}
        <div class="relative w-full h-[350px] md:h-[400px] bg-neutral-900 overflow-hidden group">
            {event.cover_photo_url ? (
                <img 
                    src={event.cover_photo_url} 
                    alt={event.title} 
                    class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity duration-700"
                />
            ) : (
                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-900 to-black">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                </div>
            )}
            
            {/* Back Button */}
            <button 
                onclick="history.back()" 
                class="absolute top-6 left-6 z-20 flex items-center gap-2 px-4 py-2 bg-black/40 hover:bg-black/60 backdrop-blur-md border border-white/10 hover:border-white/30 text-white rounded-full transition-all group shadow-lg cursor-pointer"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span class="font-medium text-sm">Back to Feed</span>
            </button>

            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-90"></div>
            
            <div class="absolute bottom-0 left-0 w-full p-6 md:p-12 max-w-7xl mx-auto">
                 <h1 class="text-4xl md:text-5xl font-extrabold text-white leading-tight drop-shadow-lg mb-4">
                    {event.title}
                </h1>
            </div>
        </div>

        {/* CONTENT GRID */}
        <div class="max-w-7xl mx-auto px-6 md:px-12 mt-8 md:mt-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                
                {/* LEFT COLUMN: Main Info */}
                <div class="lg:col-span-2 space-y-8">
                    
                    {/* Badges */}
                    <div class="flex flex-wrap gap-3">
                        {event.type && (
                            <span class="bg-primary-900/30 text-primary-400 border border-primary-500/30 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                                {event.type.name}
                            </span>
                        )}
                         {event.language && (
                            <span class="bg-blue-900/30 text-blue-400 border border-blue-500/30 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                {event.language.name}
                            </span>
                        )}
                         {event.format && (
                            <span class="bg-purple-900/30 text-purple-400 border border-purple-500/30 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                                {event.format.name}
                            </span>
                        )}
                        {event.price && (
                            <span class="bg-green-900/30 text-green-400 border border-green-500/30 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                {event.price.name}
                            </span>
                        )}
                    </div>

                    {/* Description */}
                    <div class="prose prose-invert prose-lg max-w-none text-gray-300 leading-relaxed whitespace-pre-line">
                        {event.description}
                    </div>

                </div>

                {/* RIGHT COLUMN: Sidebar Details */}
                <div class="space-y-6">
                    
                    {/* Organizer Card */}
                    <div class="bg-[#1A1A1A] border border-white/10 rounded-xl p-6 shadow-xl space-y-4">
                        <div class="border-b border-white/10 pb-4 mb-2">
                            <h3 class="text-white font-bold text-lg flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7l8-4 8 4v14"/><path d="M8 21v-4h8v4"/></svg>
                                Organizer
                            </h3>
                        </div>
                        
                        <div class="space-y-3">
                            {event.organizer && (
                                <p class="text-gray-300 font-medium">{event.organizer}</p>
                            )}
                            {event.organizer_email && (
                                <a href={`mailto:${event.organizer_email}`} class="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                    {event.organizer_email}
                                </a>
                            )}
                            {event.organizer_phone && (
                                <p class="flex items-center gap-2 text-sm text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                    {event.organizer_phone}
                                </p>
                            )}
                        </div>
                    </div>

                    {/* Links & Resources */}
                    <div class="bg-[#1A1A1A] border border-white/10 rounded-xl p-6 shadow-xl space-y-6">
                        
                        {/* Official Link */}
                        {event.external_link && (
                            <div>
                                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Official Link</h4>
                                <a 
                                    href={event.external_link} 
                                    target="_blank" 
                                    rel="noopener"
                                    class="block w-full py-3 bg-primary-600 hover:bg-primary-500 text-white text-center font-bold rounded-lg transition-colors shadow-lg shadow-primary-900/20 flex items-center justify-center gap-2"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                    Visit Official Website
                                </a>
                            </div>
                        )}

                        {/* PDF Download */}
                        {event.schedule_pdf_url && (
                             <div>
                                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Resources</h4>
                                <a 
                                    href={event.schedule_pdf_url} 
                                    target="_blank" 
                                    class="block w-full py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/30 text-gray-200 text-center font-medium rounded-lg transition-colors flex items-center justify-center gap-2 group"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400 group-hover:text-red-400 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                                    Download Program (PDF)
                                </a>
                            </div>
                        )}

                        <div class="border-t border-white/10 my-4"></div>

                        {/* Date & Location */}
                        <div class="space-y-4">
                             <div>
                                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Location</h4>
                                <p class="text-white font-medium flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                    {event.location || 'Online'}
                                </p>
                            </div>
                             <div>
                                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Start Date</h4>
                                <p class="text-white font-medium flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    {formatDate(event.start_date)}
                                </p>
                            </div>
                             {event.start_time && (
                                <div>
                                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Start Time</h4>
                                    <p class="text-white font-medium flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        {event.start_time}
                                    </p>
                                </div>
                            )}
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </main>
</Layout>
