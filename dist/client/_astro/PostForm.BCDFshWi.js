import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as u}from"./index.WFquGv8Z.js";import{s as v}from"./supabase.E32zLJp1.js";import"./index.DkUcqVkk.js";function z({currentUser:I,initialData:d}){const[a,c]=u.useState({id:d?.id||"",title:d?.title||"",slug:d?.slug||"",content:d?.content||"",featured_image_url:d?.featured_image_url||"",document_url:d?.document_url||"",source:d?.source||"",topic_id:d?.topic_id||"",metadata:d?.metadata||{gallery:[]}}),[l,b]=u.useState("image"),[S,j]=u.useState(!1),k=async t=>{const r=t.target.files?.[0];if(!r)return;const s=r.type==="application/pdf",i=r.type.startsWith("image/"),o=r.type.startsWith("video/");if(!s&&!i&&!o){alert("Format not supported.");return}j(!0);const p=new FormData;p.append("file",r);try{const g=await fetch("/api/upload",{method:"POST",body:p}),x=await g.json();if(!g.ok)throw new Error(x.error||"Upload failed");let m=x.url;o?c(n=>({...n,metadata:{...n.metadata,video_url:m}})):s?c(n=>({...n,document_url:m})):(x.format==="pdf"&&(m=m.replace(/\.pdf$/i,".jpg")),c(n=>{const y=n.metadata?.gallery||[];return n.featured_image_url?{...n,metadata:{...n.metadata,gallery:[...y,m]}}:{...n,featured_image_url:m}}))}catch(g){console.error("Upload Error:",g),alert("Failed to upload file")}finally{j(!1)}},[C,F]=u.useState(!!d?.id),f=t=>{const{name:r,value:s}=t.target;r==="slug"&&F(!0),c(i=>{let o=i.slug;return r==="slug"?o=s:r==="title"&&!C&&(o=s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")),{...i,[r]:s,slug:o}})},[h,w]=u.useState(!1),T=async t=>{t.preventDefault(),w(!0);try{const r=!!a.id,s=r?"/api/content/update":"/api/content/create",i={...a,metadata:a.metadata},o=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r?i:{type:"post",data:i})}),p=await o.json();if(!o.ok)throw new Error(p.error||"Failed to save post");alert(r?"Post updated successfully!":"Post created successfully!"),window.location.href="/"}catch(r){console.error("Submission error:",r),alert(r.message)}finally{w(!1)}};u.useEffect(()=>{!d?.id&&d?.editId&&(async()=>{const r=d.editId;try{const{data:s,error:i}=await v.from("posts").select("*").eq("id",r).single();if(i||!s)throw i;const o=s;let p="";if(o.topic_id){const{data:y}=await v.from("topics").select("slug").eq("id",o.topic_id).single(),N=y;N&&(p=N.slug)}const g=o.metadata?.gallery||[],x=o.metadata?.video_url,m=o.metadata?.youtube_url,n=o.document_url;c({id:o.id,title:o.title,slug:o.slug,content:o.content,featured_image_url:o.featured_image_url||"",document_url:n||"",source:o.source||"",topic_id:p,metadata:o.metadata||{gallery:[]}}),b(m?"youtube":x?"video":n?"pdf":"image")}catch(s){console.error("Error fetching post for edit",s),alert("Failed to load post data.")}})()},[d]);const[U,P]=u.useState([]),[_,E]=u.useState(!0);return u.useEffect(()=>{(async()=>{try{const{data:r,error:s}=await v.from("topics").select("id, name, slug").order("slug",{ascending:!0});if(s)throw s;P(r||[])}catch(r){console.error("Error loading topics",r)}finally{E(!1)}})()},[]),e.jsxs("form",{onSubmit:T,className:"space-y-6 max-w-3xl mx-auto",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"topic_id",className:"block text-sm font-medium text-[var(--text-secondary)] mb-2",children:"Topic / Category"}),e.jsxs("select",{id:"topic_id",name:"topic_id",required:!0,value:a.topic_id,onChange:f,disabled:_,className:"w-full bg-[var(--bg-body)] border border-[var(--border-color)] rounded-lg px-4 py-3 text-[var(--text-main)] placeholder-gray-500 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors appearance-none",children:[e.jsx("option",{value:"",children:_?"Loading topics...":"Select a Mining Topic..."}),U.map(t=>e.jsx("option",{value:t.slug,children:t.name},t.id))]}),e.jsx("p",{className:"text-xs text-[var(--text-secondary)] mt-1",children:"Select the most relevant mining sector for your post."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-[var(--text-secondary)] mb-2",children:"Title"}),e.jsx("input",{type:"text",name:"title",id:"title",required:!0,value:a.title,onChange:f,className:"w-full bg-[var(--bg-body)] border border-[var(--border-color)] rounded-lg px-4 py-3 text-[var(--text-main)] placeholder-gray-500 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors",placeholder:"How to optimize mining operations..."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"slug",className:"block text-sm font-medium text-[var(--text-secondary)] mb-2",children:"Slug (URL)"}),e.jsxs("div",{className:"flex rounded-md shadow-sm",children:[e.jsx("span",{className:"inline-flex items-center px-3 rounded-l-md border border-r-0 border-[var(--border-color)] bg-[var(--bg-surface-hover)] text-[var(--text-secondary)] sm:text-sm",children:"zvenia.com/post/"}),e.jsx("input",{type:"text",name:"slug",id:"slug",required:!0,value:a.slug,onChange:f,className:"flex-1 min-w-0 block w-full px-4 py-3 rounded-none rounded-r-md bg-[var(--bg-body)] border border-[var(--border-color)] text-[var(--text-main)] focus:border-primary-500 focus:ring-1 focus:ring-primary-500 sm:text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-[var(--text-main)] mb-3",children:"What would you like to share? ( Optional )"}),e.jsx("div",{className:"flex flex-wrap gap-4 mb-4",children:["image","video","pdf","youtube"].map(t=>e.jsxs("button",{type:"button",onClick:()=>{c(r=>({...r,featured_image_url:"",document_url:"",metadata:{...r.metadata,gallery:[],video_url:"",youtube_url:""}})),b(t)},className:`flex items-center gap-2 px-4 py-2 rounded-lg border transition-all capitalize ${l===t?"bg-primary-500/20 border-primary-500 text-[var(--text-main)]":"bg-[var(--bg-body)] border-[var(--border-color)] text-[var(--text-secondary)] hover:bg-[var(--bg-surface-hover)]"}`,children:[e.jsx("span",{className:`w-4 h-4 rounded-sm border ${l===t?"bg-primary-500 border-primary-500":"border-gray-500"}`}),t==="youtube"?"YouTube Video":t]},t))}),e.jsx("div",{className:"border-2 border-dashed border-[var(--border-color)] rounded-lg p-6 text-center hover:border-primary-500/50 transition-colors bg-[var(--bg-body)] min-h-[200px] flex flex-col justify-center",children:l==="youtube"?e.jsxs("div",{className:"w-full max-w-md mx-auto",children:[e.jsx("label",{className:"block text-left text-sm text-[var(--text-secondary)] mb-1",children:"YouTube Video URL"}),e.jsx("input",{type:"url",placeholder:"https://www.youtube.com/watch?v=...",className:"w-full bg-[var(--bg-surface)] border border-[var(--border-color)] rounded px-3 py-2 text-[var(--text-main)] focus:border-primary-500",value:a.metadata?.youtube_url||"",onChange:t=>c(r=>({...r,metadata:{...r.metadata,youtube_url:t.target.value}}))})]}):S?e.jsxs("div",{className:"text-[var(--text-secondary)] flex flex-col items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500 mb-2"}),e.jsx("span",{children:"Uploading..."})]}):e.jsxs(e.Fragment,{children:[a.metadata?.video_url&&l==="video"&&e.jsxs("div",{className:"relative w-full max-w-md mx-auto bg-black rounded-lg overflow-hidden border border-[var(--border-color)]",children:[e.jsx("video",{src:a.metadata.video_url,controls:!0,className:"w-full h-auto max-h-[300px]"}),e.jsx("button",{type:"button",onClick:()=>c(t=>({...t,metadata:{...t.metadata,video_url:""}})),className:"absolute top-2 right-2 bg-red-600 text-white p-1 rounded-full shadow-md z-10",children:"âœ•"})]}),a.document_url&&l==="pdf"&&e.jsxs("div",{className:"relative p-4 bg-[var(--bg-surface)] rounded-lg border border-[var(--border-color)] flex items-center justify-between max-w-md mx-auto w-full",children:[e.jsxs("div",{className:"flex items-center truncate",children:[e.jsx("div",{className:"text-2xl mr-3",children:"ðŸ“„"}),e.jsx("a",{href:a.document_url,target:"_blank",className:"text-sm text-primary-400 hover:underline truncate",children:a.document_url.split("/").pop()})]}),e.jsx("button",{type:"button",onClick:()=>c(t=>({...t,document_url:""})),className:"text-red-500 ml-2",children:"âœ•"})]}),l==="image"&&(a.featured_image_url||a.metadata?.gallery?.length>0)&&e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 w-full",children:[a.featured_image_url&&e.jsxs("div",{className:"relative group aspect-square rounded-lg overflow-hidden border-2 border-primary-500/50",children:[e.jsx("img",{src:a.featured_image_url,alt:"Main",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx("span",{className:"text-xs font-bold text-white",children:"Main"})}),e.jsx("button",{type:"button",onClick:()=>c(t=>({...t,featured_image_url:""})),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 opacity-100",children:"âœ•"})]}),a.metadata?.gallery?.map((t,r)=>e.jsxs("div",{className:"relative group aspect-square rounded-lg overflow-hidden border border-[var(--border-color)]",children:[e.jsx("img",{src:t,alt:"Gallery",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>c(s=>{const i=[...s.metadata.gallery];return i.splice(r,1),{...s,metadata:{...s.metadata,gallery:i}}}),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity",children:"âœ•"})]},r))]}),!a.metadata?.video_url&&!a.document_url&&l!=="image"||l==="image"?e.jsxs("div",{className:`mt-4 ${l==="image"&&a.featured_image_url?"inline-block w-24 h-24 align-top ml-2":""}`,children:[e.jsx("input",{type:"file",className:"hidden",id:"file-upload",accept:l==="video"?"video/mp4,video/webm,video/ogg":l==="pdf"?"application/pdf":"image/*",onChange:k,disabled:l==="video"&&!!a.metadata?.video_url||l==="pdf"&&!!a.document_url}),e.jsx("label",{htmlFor:"file-upload",className:`cursor-pointer flex flex-col items-center justify-center transition-colors ${l==="image"&&a.featured_image_url?"w-full h-full border-2 border-dashed border-[var(--border-color)] rounded-lg hover:bg-[var(--bg-surface-hover)]":"inline-block px-4 py-2 bg-[var(--bg-surface-hover)] hover:bg-[var(--bg-surface)] rounded text-sm font-bold text-[var(--text-main)]"}`,children:l==="image"&&a.featured_image_url?e.jsx("span",{className:"text-2xl text-[var(--text-secondary)]",children:"+"}):e.jsx("span",{children:l==="image"&&!a.featured_image_url?"Select Images":l==="video"?"Select Video":"Select PDF"})})]}):null]})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"source",className:"block text-sm font-medium text-[var(--text-secondary)] mb-2",children:"Source / Reference (URL or Text)"}),e.jsx("input",{type:"text",name:"source",id:"source",value:a.source,onChange:f,className:"w-full bg-[var(--bg-body)] border border-[var(--border-color)] rounded-lg px-4 py-3 text-[var(--text-main)] placeholder-gray-500 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors",placeholder:"https://example.com or 'Company Internal Report'"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"content",className:"block text-sm font-medium text-[var(--text-secondary)] mb-2",children:"Content"}),e.jsx("textarea",{name:"content",id:"content",rows:12,required:!0,value:a.content,onChange:f,className:"w-full bg-[var(--bg-body)] border border-[var(--border-color)] rounded-lg px-4 py-3 text-[var(--text-main)] placeholder-gray-500 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors font-mono text-sm",placeholder:"Write your article content here (Markdown supported)..."})]}),e.jsxs("div",{className:"pt-4 border-t border-[var(--border-color)] flex justify-end",children:[e.jsx("button",{type:"button",onClick:()=>window.location.href="/",className:"mr-3 inline-flex justify-center rounded-md border border-[var(--border-color)] bg-transparent py-3 px-8 text-sm font-medium text-[var(--text-secondary)] shadow-sm hover:bg-[var(--bg-surface-hover)] hover:text-[var(--text-main)] focus:outline-none transition-all",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:h,className:`inline-flex justify-center rounded-md border border-transparent bg-primary-600 py-3 px-8 text-sm font-medium text-white shadow-sm hover:bg-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-all transform hover:scale-105 ${h?"opacity-50 cursor-not-allowed":""}`,children:h?"Saving...":a.id?"Update Post":"Publish Post"})]})]})}export{z as default};
